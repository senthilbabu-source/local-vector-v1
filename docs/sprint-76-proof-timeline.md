# Sprint 76 â€” Before/After Proof Timeline

> **Claude Code Prompt â€” First-Pass Ready**
> Paste this entire prompt into VS Code Claude Code (Cmd+L).
> Upload alongside: `AI_RULES.md`, `CLAUDE.md`, `DEVLOG.md`, `prod_schema.sql`, `golden-tenant.ts`, `database.types.ts`

---

## ğŸ¯ Objective

Build the **Before/After Proof Timeline** â€” a visual timeline on the dashboard that correlates user actions with measurable outcomes over time. "You added FAQ schema on Feb 1 â†’ GPTBot re-crawled on Feb 7 â†’ SOV increased from 12% to 19% â†’ AI Health Score rose from 54 to 74."

This is the **PROVE** stage of the Intelligence Flywheel â€” the retention engine. Abstract visibility scores don't renew subscriptions. Showing "I did what LocalVector told me and my visibility went up 58%" does. It proves the tool works by connecting cause â†’ effect across the data LocalVector already collects.

**No new data collection.** Everything needed already exists in existing tables: `visibility_analytics` (weekly SOV snapshots), `page_audits` (audit scores over time), `content_drafts` (user-published content), `crawler_hits` (bot visit timestamps), `ai_hallucinations` (hallucination detection/resolution).

---

## ğŸ“‹ Pre-Flight Checklist â€” READ THESE FILES FIRST

```
Read docs/AI_RULES.md                          â€” All engineering rules
Read CLAUDE.md                                 â€” Project context + architecture
Read supabase/prod_schema.sql                  â€” Canonical schema (Â§1) â€” visibility_analytics, page_audits, content_drafts, crawler_hits, ai_hallucinations
Read lib/supabase/database.types.ts            â€” TypeScript DB types (Â§38)
Read src/__fixtures__/golden-tenant.ts          â€” Golden Tenant fixtures (Â§4)
Read lib/data/dashboard.ts                     â€” Dashboard data layer pattern (Sprint 64)
Read lib/services/ai-health-score.service.ts   â€” AI Health Score computation (Sprint 72)
Read app/dashboard/page.tsx                    â€” Main dashboard layout
Read app/dashboard/_components/               â€” Existing dashboard cards
Read components/layout/Sidebar.tsx             â€” NAV_ITEMS for sidebar entry
```

---

## ğŸ—ï¸ Architecture â€” What to Build

### The Core Concept: Timeline Events

The timeline is a chronological list of **events** derived from existing data. Each event has a timestamp, a type, a human-readable description, and associated metric changes. Events are correlated with metric snapshots to show cause â†’ effect.

```
Timeline Event Types:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š METRIC_SNAPSHOT â€” Weekly SOV/Health score recorded
ğŸ“ CONTENT_PUBLISHED â€” User published a content draft
ğŸ¤– BOT_CRAWL â€” AI bot crawled a Magic Menu page
ğŸ” AUDIT_COMPLETED â€” Page audit ran with new scores
ğŸ› HALLUCINATION_DETECTED â€” New hallucination found
âœ… HALLUCINATION_RESOLVED â€” Hallucination marked fixed
ğŸ—ï¸ SCHEMA_ADDED â€” FAQ/LocalBusiness schema first detected on a page
ğŸ“ˆ SOV_MILESTONE â€” SOV crossed a threshold (first mention, +10% jump, etc.)
```

### Component 1: Timeline Event Builder Service â€” `lib/services/proof-timeline.service.ts`

**Pure function.** Takes raw data from multiple tables, builds a chronological timeline with correlated metrics. No I/O, no Supabase.

```typescript
// â”€â”€ Event Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type TimelineEventType =
  | 'metric_snapshot'
  | 'content_published'
  | 'bot_crawl'
  | 'audit_completed'
  | 'hallucination_detected'
  | 'hallucination_resolved'
  | 'schema_added'
  | 'sov_milestone';

export interface TimelineEvent {
  id: string;            // deterministic, e.g. `metric-{date}`, `content-{draftId}`
  type: TimelineEventType;
  date: string;          // ISO date string
  title: string;         // Human-readable, e.g. "FAQ Schema Added"
  description: string;   // Detail, e.g. "Generated by LocalVector Schema Generator"
  icon: string;          // Emoji for display
  impact: 'positive' | 'negative' | 'neutral' | 'milestone';

  /** Metric values AT this point in time (for charting) */
  metrics?: {
    sovPercent?: number;
    healthScore?: number;
    pageAuditScore?: number;
  };
}

export interface ProofTimeline {
  events: TimelineEvent[];

  /** Summary stats for the header */
  summary: {
    /** Time range of the timeline */
    startDate: string;
    endDate: string;
    /** Net change in key metrics */
    sovDelta: number | null;       // e.g. +7.0 (percentage points)
    healthScoreDelta: number | null; // e.g. +20
    /** Count of positive actions taken */
    actionsCompleted: number;
    /** Count of hallucinations resolved */
    hallucinationsResolved: number;
  };
}

// â”€â”€ Input (raw data from multiple tables) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface TimelineInput {
  /** visibility_analytics rows ordered by snapshot_date ASC */
  snapshots: Array<{
    snapshot_date: string;
    share_of_voice: number | null;
  }>;

  /** page_audits rows with audit history */
  audits: Array<{
    last_audited_at: string;
    overall_score: number | null;
    faq_schema_present: boolean | null;
    schema_completeness_score: number | null;
  }>;

  /** content_drafts that were published */
  publishedContent: Array<{
    id: string;
    published_at: string;
    draft_title: string;
    content_type: string;
    trigger_type: string;
  }>;

  /** crawler_hits â€” first visit per bot_type */
  firstBotVisits: Array<{
    bot_type: string;
    first_crawled_at: string;
  }>;

  /** ai_hallucinations lifecycle events */
  hallucinations: Array<{
    id: string;
    claim_text: string;
    severity: string;
    detected_at: string | null;
    resolved_at: string | null;
    correction_status: string | null;
  }>;

  /** AI Health Score snapshots (computed, not stored â€” derive from snapshots + audits) */
  healthScores?: Array<{
    date: string;
    score: number;
  }>;
}

/**
 * Pure function â€” builds a proof timeline from raw data.
 * No I/O, no side effects. All timeline events are derived from input data.
 */
export function buildProofTimeline(input: TimelineInput): ProofTimeline { ... }
```

#### Event Generation Rules

```typescript
function buildProofTimeline(input: TimelineInput): ProofTimeline {
  const events: TimelineEvent[] = [];

  // 1. METRIC SNAPSHOTS â€” one per visibility_analytics row
  for (const snap of input.snapshots) {
    events.push({
      id: `metric-${snap.snapshot_date}`,
      type: 'metric_snapshot',
      date: snap.snapshot_date,
      title: 'Weekly AI Visibility Snapshot',
      description: `SOV: ${snap.share_of_voice !== null ? `${(snap.share_of_voice * 100).toFixed(0)}%` : 'N/A'}`,
      icon: 'ğŸ“Š',
      impact: 'neutral',
      metrics: { sovPercent: snap.share_of_voice !== null ? snap.share_of_voice * 100 : undefined },
    });
  }

  // 2. CONTENT PUBLISHED â€” one per published draft
  for (const draft of input.publishedContent) {
    events.push({
      id: `content-${draft.id}`,
      type: 'content_published',
      date: draft.published_at,
      title: `Published: ${draft.draft_title}`,
      description: `${formatContentType(draft.content_type)} â€” triggered by ${formatTriggerType(draft.trigger_type)}`,
      icon: 'ğŸ“',
      impact: 'positive',
    });
  }

  // 3. BOT CRAWLS â€” first visit per bot type
  for (const bot of input.firstBotVisits) {
    events.push({
      id: `bot-${bot.bot_type}`,
      type: 'bot_crawl',
      date: bot.first_crawled_at,
      title: `${formatBotLabel(bot.bot_type)} First Visit`,
      description: `${formatBotLabel(bot.bot_type)} crawled your Magic Menu for the first time`,
      icon: 'ğŸ¤–',
      impact: 'milestone',
    });
  }

  // 4. AUDIT COMPLETED â€” one per audit with significant score change
  // (skip if score didn't change from previous audit)
  // ...

  // 5. HALLUCINATION DETECTED
  for (const hall of input.hallucinations) {
    if (hall.detected_at) {
      events.push({
        id: `hall-detect-${hall.id}`,
        type: 'hallucination_detected',
        date: hall.detected_at,
        title: 'Hallucination Detected',
        description: truncate(hall.claim_text, 80),
        icon: 'ğŸ›',
        impact: 'negative',
      });
    }
  }

  // 6. HALLUCINATION RESOLVED
  for (const hall of input.hallucinations) {
    if (hall.resolved_at && (hall.correction_status === 'fixed' || hall.correction_status === 'dismissed')) {
      events.push({
        id: `hall-resolve-${hall.id}`,
        type: 'hallucination_resolved',
        date: hall.resolved_at,
        title: 'Hallucination Resolved',
        description: `"${truncate(hall.claim_text, 60)}" â€” marked ${hall.correction_status}`,
        icon: 'âœ…',
        impact: 'positive',
      });
    }
  }

  // 7. SCHEMA ADDED â€” detect first audit where faq_schema_present = true
  const firstFaqAudit = input.audits.find(a => a.faq_schema_present === true);
  if (firstFaqAudit) {
    events.push({
      id: 'schema-faq-first',
      type: 'schema_added',
      date: firstFaqAudit.last_audited_at,
      title: 'FAQ Schema Added',
      description: 'FAQ schema detected on your page for the first time',
      icon: 'ğŸ—ï¸',
      impact: 'milestone',
    });
  }

  // 8. SOV MILESTONES â€” detect first mention (SOV goes from 0 to >0)
  // and significant jumps (>= 5 percentage points week-over-week)
  // ...

  // Sort all events chronologically
  events.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

  // Build summary
  const summary = buildSummary(events, input);

  return { events, summary };
}
```

**Helper functions:**

```typescript
/** Truncate text to maxLen, appending "..." */
function truncate(text: string, maxLen: number): string { ... }

/** Format content_type for display */
function formatContentType(type: string): string {
  const map: Record<string, string> = {
    faq_page: 'FAQ Page',
    occasion_page: 'Occasion Page',
    blog_post: 'Blog Post',
    landing_page: 'Landing Page',
    gbp_post: 'Google Business Profile Post',
  };
  return map[type] ?? type;
}

/** Format trigger_type for display */
function formatTriggerType(type: string): string {
  const map: Record<string, string> = {
    competitor_gap: 'Competitor Gap',
    occasion: 'Local Occasion',
    prompt_missing: 'Missing Prompt',
    first_mover: 'First Mover Opportunity',
    manual: 'Manual',
    hallucination_correction: 'Hallucination Correction',
  };
  return map[type] ?? type;
}

/** Format bot_type to human-readable label */
function formatBotLabel(botType: string): string {
  // Reuse from lib/crawler/bot-detector.ts if possible, else lightweight map
  const map: Record<string, string> = {
    gptbot: 'GPTBot (ChatGPT)',
    'oai-searchbot': 'OAI-SearchBot (ChatGPT Search)',
    claudebot: 'ClaudeBot (Claude)',
    'google-extended': 'Google-Extended (Gemini)',
    perplexitybot: 'PerplexityBot (Perplexity)',
    // ... etc
  };
  return map[botType] ?? botType;
}

/** Build summary from events and input */
function buildSummary(events: TimelineEvent[], input: TimelineInput): ProofTimeline['summary'] {
  const dates = events.map(e => e.date).sort();
  const startDate = dates[0] ?? new Date().toISOString();
  const endDate = dates[dates.length - 1] ?? new Date().toISOString();

  // SOV delta: last snapshot SOV - first snapshot SOV
  const sovValues = input.snapshots
    .map(s => s.share_of_voice)
    .filter((v): v is number => v !== null);
  const sovDelta = sovValues.length >= 2
    ? (sovValues[sovValues.length - 1] - sovValues[0]) * 100
    : null;

  // Actions completed: published content count
  const actionsCompleted = input.publishedContent.length;

  // Hallucinations resolved count
  const hallucinationsResolved = input.hallucinations
    .filter(h => h.correction_status === 'fixed').length;

  return {
    startDate,
    endDate,
    sovDelta,
    healthScoreDelta: null, // Computed by caller if healthScores provided
    actionsCompleted,
    hallucinationsResolved,
  };
}
```

---

### Component 2: Data Fetcher â€” `lib/data/proof-timeline.ts`

Fetches all timeline source data in parallel, assembles `TimelineInput`, calls `buildProofTimeline()`.

```typescript
import type { SupabaseClient } from '@supabase/supabase-js';
import type { Database } from '@/lib/supabase/database.types';
import { buildProofTimeline, type ProofTimeline, type TimelineInput } from '@/lib/services/proof-timeline.service';

/**
 * Fetches data for the proof timeline from 5 tables in parallel.
 * Scoped to org_id + location_id (AI_RULES Â§18).
 * Default window: last 90 days.
 */
export async function fetchProofTimeline(
  supabase: SupabaseClient<Database>,
  orgId: string,
  locationId: string,
  windowDays: number = 90
): Promise<ProofTimeline> {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - windowDays);
  const cutoffISO = cutoff.toISOString();

  const [snapshots, audits, publishedContent, firstBotVisits, hallucinations] =
    await Promise.all([
      // 1. visibility_analytics â€” weekly snapshots
      supabase
        .from('visibility_analytics')
        .select('snapshot_date, share_of_voice')
        .eq('org_id', orgId)
        .eq('location_id', locationId)
        .gte('snapshot_date', cutoffISO.split('T')[0])
        .order('snapshot_date', { ascending: true }),

      // 2. page_audits â€” audit history
      supabase
        .from('page_audits')
        .select('last_audited_at, overall_score, faq_schema_present, schema_completeness_score')
        .eq('org_id', orgId)
        .gte('last_audited_at', cutoffISO)
        .order('last_audited_at', { ascending: true }),

      // 3. content_drafts â€” published only
      supabase
        .from('content_drafts')
        .select('id, published_at, draft_title, content_type, trigger_type')
        .eq('org_id', orgId)
        .eq('status', 'published')
        .not('published_at', 'is', null)
        .gte('published_at', cutoffISO)
        .order('published_at', { ascending: true }),

      // 4. crawler_hits â€” first visit per bot_type (aggregate in TS)
      supabase
        .from('crawler_hits')
        .select('bot_type, crawled_at')
        .eq('org_id', orgId)
        .gte('crawled_at', cutoffISO)
        .order('crawled_at', { ascending: true }),

      // 5. ai_hallucinations â€” lifecycle events
      supabase
        .from('ai_hallucinations')
        .select('id, claim_text, severity, detected_at, resolved_at, correction_status')
        .eq('org_id', orgId)
        .or(`detected_at.gte.${cutoffISO},resolved_at.gte.${cutoffISO}`)
        .order('detected_at', { ascending: true }),
    ]);

  // Aggregate first bot visits: earliest crawled_at per bot_type
  const botFirstVisitMap = new Map<string, string>();
  for (const hit of firstBotVisits.data ?? []) {
    if (!botFirstVisitMap.has(hit.bot_type)) {
      botFirstVisitMap.set(hit.bot_type, hit.crawled_at!);
    }
  }
  const firstBotVisitList = Array.from(botFirstVisitMap.entries()).map(
    ([bot_type, first_crawled_at]) => ({ bot_type, first_crawled_at })
  );

  const input: TimelineInput = {
    snapshots: snapshots.data ?? [],
    audits: (audits.data ?? []).map(a => ({
      ...a,
      faq_schema_present: a.faq_schema_present ?? null,
      schema_completeness_score: a.schema_completeness_score ?? null,
    })),
    publishedContent: (publishedContent.data ?? []).map(d => ({
      ...d,
      published_at: d.published_at!,
    })),
    firstBotVisits: firstBotVisitList,
    hallucinations: (hallucinations.data ?? []).map(h => ({
      ...h,
      severity: h.severity ?? 'high',
      correction_status: h.correction_status ?? 'open',
    })),
  };

  return buildProofTimeline(input);
}
```

---

### Component 3: Server Action â€” `app/dashboard/actions/proof-timeline.ts`

```typescript
'use server';

import { getSafeAuthContext } from '@/lib/auth';
import { createClient } from '@/lib/supabase/server';
import { fetchProofTimeline } from '@/lib/data/proof-timeline';
import type { ProofTimeline } from '@/lib/services/proof-timeline.service';

/**
 * Server Action: Fetch proof timeline for the primary location.
 */
export async function getProofTimeline(): Promise<
  { success: true; data: ProofTimeline } |
  { success: false; error: string }
> {
  const ctx = await getSafeAuthContext();
  if (!ctx?.orgId) return { success: false, error: 'Unauthorized' };

  const supabase = await createClient();

  // Get primary location
  const { data: location } = await supabase
    .from('locations')
    .select('id')
    .eq('org_id', ctx.orgId)
    .eq('is_primary', true)
    .maybeSingle();

  if (!location) return { success: false, error: 'No primary location' };

  const timeline = await fetchProofTimeline(supabase, ctx.orgId, location.id);
  return { success: true, data: timeline };
}
```

---

### Component 4: Dashboard Page â€” `app/dashboard/proof-timeline/page.tsx`

**New dashboard page â€” Server Component** with the full timeline visualization.

**Sidebar entry:** Add to `NAV_ITEMS` in `components/layout/Sidebar.tsx`:
- Label: `"Proof Timeline"`
- Icon: `TrendingUp` from `lucide-react`
- Href: `/dashboard/proof-timeline`
- Position: after "Bot Activity" and before "AI Assistant"

#### Page Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ Before / After â€” Your AI Visibility Journey                  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ SOV      â”‚  â”‚ Actions  â”‚  â”‚ Issues   â”‚  â”‚ Timeline â”‚        â”‚
â”‚  â”‚ +7%      â”‚  â”‚ 5 done   â”‚  â”‚ 2 fixed  â”‚  â”‚ 90 days  â”‚        â”‚
â”‚  â”‚ â–² growth â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                   â”‚
â”‚  â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  Feb 22  ğŸ“Š Weekly AI Visibility Snapshot                        â”‚
â”‚              SOV: 19%  Â· AI Health: 74                           â”‚
â”‚              ğŸ“ˆ +58% SOV improvement since start                 â”‚
â”‚                                                                   â”‚
â”‚  Feb 15  ğŸ“Š Weekly AI Visibility Snapshot                        â”‚
â”‚              SOV: 17%  Â· AI Health: 71                           â”‚
â”‚          ğŸ¤– PerplexityBot First Visit                             â”‚
â”‚              PerplexityBot crawled your Magic Menu for the       â”‚
â”‚              first time â€” Perplexity now knows about you!        â”‚
â”‚                                                                   â”‚
â”‚  Feb 8   ğŸ“Š Weekly AI Visibility Snapshot                        â”‚
â”‚              SOV: 12%  Â· AI Health: 62                           â”‚
â”‚          ğŸ¤– GPTBot re-crawled menu page                          â”‚
â”‚              Second visit this month                              â”‚
â”‚                                                                   â”‚
â”‚  Feb 1   ğŸ“Š Weekly AI Visibility Snapshot                        â”‚
â”‚              SOV: 12%  Â· AI Health: 54                           â”‚
â”‚          ğŸ—ï¸ FAQ Schema Added                                     â”‚
â”‚              Generated by LocalVector Schema Generator            â”‚
â”‚          ğŸ“ Published: FAQ Page for Hookah Menu                  â”‚
â”‚              FAQ Page â€” triggered by Competitor Gap               â”‚
â”‚                                                                   â”‚
â”‚  â”€â”€ Null State (no events) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  Your timeline will fill up as LocalVector monitors your AI      â”‚
â”‚  visibility. Check back after your first weekly SOV snapshot.    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Implementation Details

- **Server Component** â€” data fetched via `getProofTimeline()` server action at page level.
- **Reverse chronological** â€” newest events at top (user sees most recent changes first).
- **Grouped by date** â€” events on the same date are grouped under a single date header.
- **Vertical timeline line** â€” left border / CSS timeline connector between date groups.
- **Impact coloring:**
  - `positive` â†’ green text (`text-green-400`)
  - `negative` â†’ crimson text (`text-red-400`)
  - `neutral` â†’ slate text (`text-slate-400`)
  - `milestone` â†’ indigo text (`text-indigo-400`) with a star/badge
- **Summary strip** at top: SOV delta (green if positive, red if negative), actions completed, hallucinations resolved, timeline window.
- **No plan gating.** Proof Timeline is available to ALL tiers. It's the retention tool that justifies upgrading.

**Error boundary:** Create `app/dashboard/proof-timeline/error.tsx`.

---

### Component 5: Dashboard Summary Card â€” `app/dashboard/_components/ProofTimelineCard.tsx`

Compact card on the main dashboard linking to the full timeline page.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ Your Progress (Last 90 Days)        â”‚
â”‚                                          â”‚
â”‚  SOV: +7% Â· 5 actions Â· 2 issues fixed  â”‚
â”‚  [View Full Timeline â†’]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- If no events exist: "Your timeline is starting â€” check back next week."
- Highlight the single most impactful event (e.g., first bot crawl, biggest SOV jump).

Add to `app/dashboard/page.tsx`.

---

### Component 6: Seed Data â€” `supabase/seed.sql`

Add historical snapshot data to make the timeline useful in development:

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Section 19: Proof Timeline Seed Data (Sprint 76)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Additional visibility_analytics rows for timeline history
-- Uses existing org_id a0eebc99, location_id b0eebc99

-- Week 1 baseline (4 weeks ago)
INSERT INTO public.visibility_analytics (id, org_id, location_id, share_of_voice, citation_rate, sentiment_gap, snapshot_date) VALUES
  ('f0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 0.12, 0.40, 0.05, CURRENT_DATE - INTERVAL '28 days');

-- Week 2 (after schema added)
INSERT INTO public.visibility_analytics (id, org_id, location_id, share_of_voice, citation_rate, sentiment_gap, snapshot_date) VALUES
  ('f1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 0.12, 0.45, 0.04, CURRENT_DATE - INTERVAL '21 days');

-- Week 3 (SOV uptick)
INSERT INTO public.visibility_analytics (id, org_id, location_id, share_of_voice, citation_rate, sentiment_gap, snapshot_date) VALUES
  ('f2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 0.17, 0.50, 0.03, CURRENT_DATE - INTERVAL '14 days');

-- Week 4 (continued growth)
INSERT INTO public.visibility_analytics (id, org_id, location_id, share_of_voice, citation_rate, sentiment_gap, snapshot_date) VALUES
  ('f3eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 0.19, 0.52, 0.02, CURRENT_DATE - INTERVAL '7 days');
```

Register UUIDs `f0`â€“`f3` in the reference card.

**NOTE:** Check if existing seed already has visibility_analytics rows that would conflict with the UNIQUE constraint on `(org_id, location_id, snapshot_date)`. If so, use `ON CONFLICT DO NOTHING` or adjust dates. Read `supabase/seed.sql` first.

---

### Component 7: Golden Tenant Fixture â€” `src/__fixtures__/golden-tenant.ts`

```typescript
/**
 * Sprint 76 â€” Canonical TimelineInput fixture for Charcoal N Chill.
 * 4 weeks of data showing SOV improvement after schema addition.
 */
export const MOCK_TIMELINE_INPUT: import('@/lib/services/proof-timeline.service').TimelineInput = {
  snapshots: [
    { snapshot_date: '2026-01-29', share_of_voice: 0.12 },
    { snapshot_date: '2026-02-05', share_of_voice: 0.12 },
    { snapshot_date: '2026-02-12', share_of_voice: 0.17 },
    { snapshot_date: '2026-02-19', share_of_voice: 0.19 },
  ],
  audits: [
    { last_audited_at: '2026-01-30T10:00:00.000Z', overall_score: 54, faq_schema_present: false, schema_completeness_score: 20 },
    { last_audited_at: '2026-02-06T10:00:00.000Z', overall_score: 72, faq_schema_present: true, schema_completeness_score: 85 },
  ],
  publishedContent: [
    {
      id: 'd0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11',
      published_at: '2026-02-01T14:00:00.000Z',
      draft_title: 'FAQ Page: Hookah Menu & Experience',
      content_type: 'faq_page',
      trigger_type: 'competitor_gap',
    },
  ],
  firstBotVisits: [
    { bot_type: 'gptbot', first_crawled_at: '2026-02-07T08:00:00.000Z' },
    { bot_type: 'perplexitybot', first_crawled_at: '2026-02-14T12:00:00.000Z' },
  ],
  hallucinations: [
    {
      id: 'b1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11',
      claim_text: 'Charcoal N Chill appears to be permanently closed.',
      severity: 'critical',
      detected_at: '2026-01-28T09:00:00.000Z',
      resolved_at: '2026-02-15T11:00:00.000Z',
      correction_status: 'fixed',
    },
  ],
};
```

---

## ğŸ§ª Testing â€” Write Tests FIRST (AI_RULES Â§4)

### Test File 1: `src/__tests__/unit/proof-timeline-service.test.ts`

**Target: `lib/services/proof-timeline.service.ts`**

```
describe('buildProofTimeline')
  Event generation:
  1.  generates metric_snapshot events from visibility_analytics rows
  2.  generates content_published events from published drafts
  3.  generates bot_crawl events from first bot visits
  4.  generates hallucination_detected events from detected_at
  5.  generates hallucination_resolved events from resolved_at where status=fixed
  6.  does not generate hallucination_resolved for status=open
  7.  generates schema_added event when faq_schema_present transitions to true
  8.  does not generate schema_added when faq_schema_present is always false
  9.  generates sov_milestone when SOV goes from 0 to >0 (first mention)
  10. generates sov_milestone for >= 5pp jump week-over-week

  Sorting and grouping:
  11. sorts events chronologically (oldest first)
  12. assigns deterministic IDs (metric-{date}, content-{id}, etc.)

  Summary:
  13. calculates sovDelta from first to last snapshot
  14. sovDelta is null when fewer than 2 snapshots
  15. counts actionsCompleted from published content
  16. counts hallucinationsResolved from fixed hallucinations
  17. sets startDate and endDate from event date range

  Impact classification:
  18. content_published has impact='positive'
  19. hallucination_detected has impact='negative'
  20. bot_crawl has impact='milestone'
  21. metric_snapshot has impact='neutral'

  Edge cases:
  22. handles empty input (no data) â€” returns empty events + zeroed summary
  23. handles single snapshot (no delta) â€” sovDelta=null
  24. handles MOCK_TIMELINE_INPUT and produces correct event count
  25. truncates long claim_text in hallucination descriptions

describe('formatContentType')
  26. maps faq_page â†’ 'FAQ Page'
  27. maps gbp_post â†’ 'Google Business Profile Post'
  28. returns raw type for unknown values

describe('formatTriggerType')
  29. maps hallucination_correction â†’ 'Hallucination Correction'
  30. returns raw type for unknown values
```

**30 tests total. No mocks â€” pure functions.**

### Test File 2: `src/__tests__/unit/proof-timeline-data.test.ts`

**Target: `lib/data/proof-timeline.ts`**

```
describe('fetchProofTimeline')
  1. runs 5 queries in parallel
  2. scopes all queries by org_id (Â§18)
  3. uses 90-day default window
  4. aggregates first bot visit per bot_type
  5. filters content_drafts to status='published' only
  6. handles empty results from all tables
  7. calls buildProofTimeline with assembled input
```

**7 tests total.**

### Test File 3: `src/__tests__/unit/proof-timeline-action.test.ts`

**Target: `app/dashboard/actions/proof-timeline.ts`**

```
describe('getProofTimeline')
  1. returns Unauthorized when no session
  2. returns error when no primary location
  3. returns success with ProofTimeline on happy path
  4. passes org_id and location_id to fetchProofTimeline
```

**4 tests total.**

### Test File 4: `src/__tests__/unit/sidebar-timeline.test.ts`

**Target: `components/layout/Sidebar.tsx`**

```
describe('Sidebar NAV_ITEMS â€” Proof Timeline')
  1. NAV_ITEMS includes Proof Timeline entry
  2. Proof Timeline has correct href /dashboard/proof-timeline
  3. Proof Timeline is positioned after Bot Activity
```

**3 tests total.**

---

## ğŸ“‚ Files to Create/Modify

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `lib/services/proof-timeline.service.ts` | **CREATE** | Pure timeline builder (events + summary) |
| 2 | `lib/data/proof-timeline.ts` | **CREATE** | Data fetcher â€” 5 parallel queries â†’ TimelineInput |
| 3 | `app/dashboard/actions/proof-timeline.ts` | **CREATE** | Server Action â€” getSafeAuthContext + primary location |
| 4 | `app/dashboard/proof-timeline/page.tsx` | **CREATE** | Full timeline page (Server Component) |
| 5 | `app/dashboard/proof-timeline/error.tsx` | **CREATE** | Error boundary |
| 6 | `app/dashboard/_components/ProofTimelineCard.tsx` | **CREATE** | Summary card for main dashboard |
| 7 | `app/dashboard/page.tsx` | **MODIFY** | Add ProofTimelineCard |
| 8 | `components/layout/Sidebar.tsx` | **MODIFY** | Add Proof Timeline to NAV_ITEMS |
| 9 | `supabase/seed.sql` | **MODIFY** | Add historical visibility_analytics rows |
| 10 | `src/__fixtures__/golden-tenant.ts` | **MODIFY** | Add MOCK_TIMELINE_INPUT |
| 11 | `src/__tests__/unit/proof-timeline-service.test.ts` | **CREATE** | 30 tests â€” pure functions |
| 12 | `src/__tests__/unit/proof-timeline-data.test.ts` | **CREATE** | 7 tests â€” data layer |
| 13 | `src/__tests__/unit/proof-timeline-action.test.ts` | **CREATE** | 4 tests â€” server action |
| 14 | `src/__tests__/unit/sidebar-timeline.test.ts` | **CREATE** | 3 tests â€” sidebar nav |

**Expected test count: 44 new tests across 4 files.**

---

## ğŸš« What NOT to Do

1. **DO NOT create a new table.** The timeline is computed from existing tables. No `proof_timeline` table, no timeline event storage.
2. **DO NOT use AI/LLM to generate event descriptions.** All text is deterministic from the data.
3. **DO NOT trigger timeline computation on page load with heavy queries** â€” this IS page-load data, but all 5 queries are lightweight (indexed columns, reasonable row counts with 90-day window). If performance is a concern, cache via `unstable_cache` with a 1-hour revalidation.
4. **DO NOT plan-gate the timeline.** Available to all tiers â€” it's the retention feature.
5. **DO NOT fabricate timeline events** (AI_RULES Â§20, Â§24). If there's no data, show the null state honestly.
6. **DO NOT compute AI Health Score history** in this sprint. Health Score is computed on-demand (Sprint 72) and has no historical table. The timeline shows SOV and page audit scores which DO have history. Health Score history can be added in a future sprint if a snapshot table is created.
7. **DO NOT use `as any` on Supabase clients** (AI_RULES Â§38.2).
8. **DO NOT create files under `supabase/functions/`** (AI_RULES Â§6).
9. **DO NOT use dynamic Tailwind classes** for impact colors (AI_RULES Â§12). Use literal classes.
10. **DO NOT import `detectAIBot` into the timeline service** â€” use a lightweight label map instead to keep the service pure with no indirect dependencies.

---

## âœ… Definition of Done (AI_RULES Â§13.5)

- [ ] `lib/services/proof-timeline.service.ts` â€” Pure function, 8 event types, chronological sorting, summary stats
- [ ] `lib/data/proof-timeline.ts` â€” 5 parallel queries with 90-day window, bot visit aggregation
- [ ] `app/dashboard/actions/proof-timeline.ts` â€” Server Action with getSafeAuthContext
- [ ] `app/dashboard/proof-timeline/page.tsx` â€” Full page with timeline visualization, null state
- [ ] `app/dashboard/_components/ProofTimelineCard.tsx` â€” Summary card on main dashboard
- [ ] Sidebar has "Proof Timeline" nav entry
- [ ] Seed data has 4 historical visibility_analytics rows
- [ ] `MOCK_TIMELINE_INPUT` added to golden-tenant
- [ ] `npx vitest run src/__tests__/unit/proof-timeline-service.test.ts` â€” 30 tests passing
- [ ] `npx vitest run src/__tests__/unit/proof-timeline-data.test.ts` â€” 7 tests passing
- [ ] `npx vitest run src/__tests__/unit/proof-timeline-action.test.ts` â€” 4 tests passing
- [ ] `npx vitest run src/__tests__/unit/sidebar-timeline.test.ts` â€” 3 tests passing
- [ ] `npx vitest run` â€” ALL tests passing, no regressions
- [ ] `npx tsc --noEmit` â€” 0 new type errors
- [ ] DEVLOG.md entry written

---

## ğŸ““ DEVLOG Entry Format (AI_RULES Â§13.2)

```markdown
## 2026-02-28 â€” Sprint 76: Before/After Proof Timeline (Completed)

**Goal:** Build a visual timeline correlating user actions with measurable outcomes â€” "You added FAQ schema â†’ GPTBot re-crawled â†’ SOV increased 58% in 3 weeks" â€” proving ROI and driving retention.

**Scope:**
- `lib/services/proof-timeline.service.ts` â€” **NEW.** Pure timeline builder (~350 lines). Exports: `buildProofTimeline()` (8 event types: metric_snapshot, content_published, bot_crawl, audit_completed, hallucination_detected, hallucination_resolved, schema_added, sov_milestone), `formatContentType()`, `formatTriggerType()`, `formatBotLabel()`. Chronological sorting, summary stats (sovDelta, actionsCompleted, hallucinationsResolved). No I/O.
- `lib/data/proof-timeline.ts` â€” **NEW.** Data fetcher. 5 parallel Supabase queries (visibility_analytics, page_audits, content_drafts, crawler_hits, ai_hallucinations) with 90-day window. Aggregates first bot visit per bot_type. Assembles TimelineInput, delegates to buildProofTimeline.
- `app/dashboard/actions/proof-timeline.ts` â€” **NEW.** Server Action: `getProofTimeline()` with `getSafeAuthContext()`, primary location lookup.
- `app/dashboard/proof-timeline/page.tsx` â€” **NEW.** Server Component. Summary strip (SOV delta, actions completed, issues fixed, timeline window). Reverse-chronological event list grouped by date. Vertical timeline connector. Impact-colored event cards. Null state for new tenants.
- `app/dashboard/proof-timeline/error.tsx` â€” **NEW.** Error boundary.
- `app/dashboard/_components/ProofTimelineCard.tsx` â€” **NEW.** Summary card for main dashboard linking to full timeline.
- `app/dashboard/page.tsx` â€” **MODIFIED.** Added ProofTimelineCard.
- `components/layout/Sidebar.tsx` â€” **MODIFIED.** Added "Proof Timeline" (TrendingUp icon) after Bot Activity.
- `supabase/seed.sql` â€” **MODIFIED.** Added 4 historical visibility_analytics rows (UUIDs f0â€“f3) showing SOV progression over 4 weeks.
- `src/__fixtures__/golden-tenant.ts` â€” **MODIFIED.** Added `MOCK_TIMELINE_INPUT` with 4 weeks of multi-source data.

**Tests added:**
- `src/__tests__/unit/proof-timeline-service.test.ts` â€” **N Vitest tests.** Event generation for all 8 types, sorting, summary stats, impact classification, edge cases (empty input, single snapshot, long text truncation).
- `src/__tests__/unit/proof-timeline-data.test.ts` â€” **N Vitest tests.** Parallel queries, org scoping, bot visit aggregation, published-only filter.
- `src/__tests__/unit/proof-timeline-action.test.ts` â€” **N Vitest tests.** Auth guard, no-location, happy path.
- `src/__tests__/unit/sidebar-timeline.test.ts` â€” **N Vitest tests.** NAV_ITEMS entry, href, position.

**Run commands:**
```bash
npx vitest run src/__tests__/unit/proof-timeline-service.test.ts   # N tests passing
npx vitest run src/__tests__/unit/proof-timeline-data.test.ts      # N tests passing
npx vitest run src/__tests__/unit/proof-timeline-action.test.ts    # N tests passing
npx vitest run src/__tests__/unit/sidebar-timeline.test.ts         # N tests passing
npx vitest run                                                      # All tests passing
```

**Note:** Replace N with actual test counts verified via `grep -cE "^\s*(it|test)\("` (AI_RULES Â§13.3).
```

---

## ğŸ”— Sprint Dependencies

| Dependency | Sprint | What It Provides |
|-----------|--------|-----------------|
| `visibility_analytics` table + weekly SOV cron | Sprint 41 | Weekly SOV snapshots (share_of_voice by date) |
| `page_audits` with dimension scores | Sprint 71 | Audit score history + faq_schema_present |
| `content_drafts` with publish flow | Sprint 48 | Published content events with timestamps |
| `crawler_hits` wired in middleware | Sprint 73 | Bot crawl timestamps |
| `ai_hallucinations` lifecycle | Sprint 68+ | Detection + resolution timestamps |
| Dashboard data layer pattern | Sprint 64 | `lib/data/` fetcher pattern |
| Sidebar NAV_ITEMS | Sprint 73 | Testable nav array |

---

## ğŸ§  Edge Cases to Handle

1. **Brand new tenant (no data):** All tables return empty. Timeline has zero events. Null state: "Your timeline will fill up as LocalVector monitors your AI visibility."
2. **Only 1 snapshot (just started):** No SOV delta computable. `sovDelta: null`. Show single snapshot event.
3. **SOV decreased:** `sovDelta` is negative. Display in red. This is honest â€” retention means showing real results, even bad ones.
4. **Hallucination detected but never resolved:** Only the `hallucination_detected` event appears. No `hallucination_resolved` event.
5. **Content published but no SOV improvement yet:** Timeline shows the publish event but the metric snapshots after it may not show change. This is fine â€” the timeline is factual, not guaranteed causation.
6. **Multiple events on the same date:** Group under one date header. Order by time within the day.
7. **Bot crawl outside the 90-day window:** Not included. The window is configurable but defaults to 90 days.
8. **visibility_analytics UNIQUE constraint conflict:** Seed data uses `ON CONFLICT DO NOTHING` or carefully chosen dates that don't overlap with existing seed rows.
