# Sprint C ‚Äî Hardening: Honest Listings, Test Coverage, Digest Guard & Seat Cost

> **Claude Code Prompt ‚Äî Bulletproof Edition**
> Paste this entire prompt into VS Code Claude Code (Cmd+L).
> Upload alongside: `AI_RULES.md`, `CLAUDE.md`, `DEVLOG.md`, `prod_schema.sql`, `golden-tenant.ts`, `database.types.ts`, `MEMORY.md`
> **Prerequisites:** Sprint A and Sprint B must be fully merged and all their tests passing before starting Sprint C.

---

## üéØ Objective

Sprint C closes the remaining critical and medium-priority gaps from the February 2026 code analysis. This is a hardening sprint ‚Äî less UI glamour, more reliability, honesty, and coverage. Every fix makes the product more trustworthy either to customers or to you as the operator.

1. **C2 ‚Äî Honest Listings State** ‚Äî Five of the six "Big 6 Listings" platforms are simulating a sync with `setTimeout(2000)`. Paying customers click "Sync" and get a false ‚úì. This sprint replaces the mock with an honest, accurate UI: GBP shows real sync status; the other five are labeled "Manual URL tracking ‚Äî automated sync coming soon" with a clear upgrade path. No fake buttons, no fake progress.
2. **M1 ‚Äî Test Coverage for 6 Untested Services** ‚Äî Five critical services have zero unit tests. One of them (`gbp-token-refresh`) is the sole mechanism keeping GBP OAuth tokens alive for every connected customer. These tests also cover 6 E2E page gaps (pages that exist but have no Playwright coverage).
3. **L2 ‚Äî Weekly Digest Guard** ‚Äî The weekly digest cron sends emails even when an org has no scan data yet. New users receive a digest showing "Reality Score: ‚Äî" as their first email from LocalVector. This sprint adds a guard and fixes the bare `catch {}` at line 86.
4. **H6 ‚Äî `monthlyCostPerSeat: null` TODO** ‚Äî Agency customers on the highest-priced plan can't see their per-seat cost on the billing page. A hardcoded `null` has been shipped to production. This sprint fetches the real value from the Stripe Price API.
5. **L3 ‚Äî Content Calendar ‚Üí Drafts Breadcrumb** ‚Äî Drafts that originated from the Occasion Engine have no indication of their source. A single "Generated by Occasion Engine" tag closes the gap between the two pages without touching their data flow.

**Why this sprint third:** Sprints A and B established observability and first impressions. Sprint C makes the product honest (no fake syncs), reliable (untested critical services get coverage), and complete (digest guard, seat cost). This is the last sprint before the product is ready for active customer acquisition without meaningful trust or reliability risks.

**Estimated total implementation time:** 25‚Äì35 hours. The test writing in M1 is the largest chunk ‚Äî budget 15‚Äì18 hours for it alone.

---

## üìã Pre-Flight Checklist ‚Äî READ THESE FILES FIRST

Before writing ANY code, read these files in order. Do not skip any.

```
Read docs/AI_RULES.md                                                         ‚Äî All engineering rules (now includes Rules 42‚Äì46 from Sprints A‚ÄìB)
Read CLAUDE.md                                                                 ‚Äî Project context, implementation inventory
Read MEMORY.md                                                                 ‚Äî Architecture decisions (now includes Sprint A‚ÄìB decisions)
Read supabase/prod_schema.sql                                                  ‚Äî Canonical schema
Read lib/supabase/database.types.ts                                            ‚Äî TypeScript DB types
Read src/__fixtures__/golden-tenant.ts                                         ‚Äî Golden tenant fixtures

--- C2: Listings ---
Read app/dashboard/integrations/actions.ts                                     ‚Äî Lines 94‚Äì160: the mock sync logic; read the entire file
Read app/dashboard/integrations/_components/PlatformRow.tsx                    ‚Äî Line 158 and full component
Read app/dashboard/integrations/page.tsx                                       ‚Äî Listings page layout and data flow
Read app/dashboard/integrations/_components/                                   ‚Äî All components in this folder
Read app/api/auth/google-business/callback/route.ts                            ‚Äî Real GBP OAuth (reference for what real looks like)

--- M1: Services to test ---
Read lib/services/cron-logger.ts                                               ‚Äî Understand exports, parameters, DB writes
Read lib/services/entity-auto-detect.ts                                        ‚Äî Understand entity detection logic and dependencies
Read lib/services/places-refresh.ts                                            ‚Äî Understand Places API call pattern and DB writes
Read lib/services/sov-seed.ts                                                  ‚Äî Understand SOV seed query generation
Read lib/gbp/gbp-token-refresh.ts   (OR lib/services/gbp-token-refresh.ts)    ‚Äî Token refresh logic (check BOTH paths ‚Äî see note below)
Read app/api/cron/refresh-gbp-tokens/route.ts                                  ‚Äî How token refresh is called in production
Read src/__tests__/unit/                                                       ‚Äî Read 3‚Äì4 existing unit test files to understand the test patterns used
Read src/__tests__/e2e/                                                        ‚Äî Read 2‚Äì3 existing e2e specs to understand helpers, auth, route mocking

--- L2: Weekly digest ---
Read app/api/cron/weekly-digest/route.ts                                       ‚Äî Line 86: bare catch; full cron logic
Read lib/services/weekly-digest.service.ts                                     ‚Äî Full digest service: what data it fetches, what it sends

--- H6: Seat cost ---
Read app/actions/seat-actions.ts                                               ‚Äî Line 190: monthlyCostPerSeat: null TODO
Read app/dashboard/billing/page.tsx                                            ‚Äî Where SeatManagementCard is rendered
Read app/dashboard/billing/_components/SeatManagementCard.tsx                 ‚Äî How the seat cost is displayed
Read lib/stripe/                                                               ‚Äî Existing Stripe helpers; look for price fetch utilities
Read .env.example  (or check MEMORY.md)                                       ‚Äî Stripe API key env var names used in the project

--- L3: Content calendar breadcrumb ---
Read app/dashboard/content-calendar/                                           ‚Äî Full directory: page, components, data shapes
Read app/dashboard/content-drafts/                                             ‚Äî Full directory: page, components, how drafts are stored
Read supabase/prod_schema.sql                                                  ‚Äî Find content_drafts or occasion_drafts table; look for origin/source column
```

**Critical disambiguation ‚Äî `gbp-token-refresh.ts` file location:**

The code analysis report references `lib/services/gbp-token-refresh.ts`. Sprint 89 (if it ran before this sprint) may have created `lib/gbp/gbp-token-refresh.ts` instead. **Check both paths:**

```bash
ls lib/services/ | grep token
ls lib/gbp/ | grep token
```

Use whichever file actually exists. If Sprint 89 has not run yet, the service is at `lib/services/gbp-token-refresh.ts`. If Sprint 89 ran, use `lib/gbp/gbp-token-refresh.ts`. The test file path must match the actual implementation path. Do not import from both ‚Äî find the canonical location and reference only that.

**Specifically understand before writing code:**
- The exact structure of the "Big 6 Listings" in the integrations page ‚Äî are they rendered from a static array? A DB table? A mix? You need to know the data model before changing the UI.
- Whether `integrations` status is persisted in the DB or is pure client state. If it's only client state, the `setTimeout(2000) ‚Üí connected` pattern can be replaced without a migration. If it's persisted, you may need a migration.
- The existing Stripe utilities ‚Äî do they already have a `getStripePrice(priceId)` helper, or will you write one from scratch?
- What columns exist on the `content_drafts` table ‚Äî specifically whether there's already an `occasion_id`, `source`, or `origin` column that links drafts to calendar events.

---

## üèóÔ∏è Architecture ‚Äî What to Build

---

### Fix C2: Honest Listings State

**The problem in precise terms:**

```typescript
// CURRENT ‚Äî app/dashboard/integrations/actions.ts lines 94‚Äì160:
// Phase 8 uses a mock implementation:
//   1. Set status ‚Üí 'syncing'
//   2. Await 2,000 ms (simulates a real API round-trip)
//   3. Set status ‚Üí 'connected'
// Real API logic drops in at step 2 in Phase 8b
```

A paying customer clicks "Sync Now" on Yelp. After 2 seconds, it says ‚úì Connected. Nothing happened. Their Yelp listing was not checked. This is not a UX approximation ‚Äî it's a false representation of a paid feature. It must stop.

**Resolution strategy:** GBP stays real. The other 5 get honest, accurate UI states. No fake progress, no fake connected status.

#### Step 1: Understand the platform data model

Read `integrations/page.tsx` and `integrations/actions.ts` carefully. Determine:
- Are the 6 platforms defined as a static array in the frontend, or fetched from a DB table?
- What columns exist: `platform_id`, `name`, `status`, `connected_at`, `sync_type`?
- Is connection status persisted in a DB table (e.g., `platform_connections`) or held in React state only?

If persisted in DB: you may need a migration to add a `sync_type` column. If client-state only: the change is purely in the UI/action layer.

#### Step 2: Define platform sync types

Create a constant that categorizes each platform:

```typescript
// lib/integrations/platform-config.ts

export type PlatformSyncType = 'real_oauth' | 'manual_url' | 'coming_soon';

export interface PlatformConfig {
  id: string;
  name: string;
  /** Human-readable name for display */
  displayName: string;
  /** Icon or logo identifier */
  icon: string;
  /** How this platform is synced */
  syncType: PlatformSyncType;
  /** Shown in the "coming soon" badge or manual tracking helper text */
  eta?: string;
  /** URL where users can claim/manage their listing on this platform */
  claimUrl?: string;
}

export const PLATFORM_CONFIG: PlatformConfig[] = [
  {
    id: 'google',
    name: 'Google Business Profile',
    displayName: 'Google Business Profile',
    icon: 'google',
    syncType: 'real_oauth',
  },
  {
    id: 'yelp',
    name: 'Yelp',
    displayName: 'Yelp for Business',
    icon: 'yelp',
    syncType: 'manual_url',
    claimUrl: 'https://biz.yelp.com',
  },
  {
    id: 'tripadvisor',
    name: 'TripAdvisor',
    displayName: 'TripAdvisor',
    icon: 'tripadvisor',
    syncType: 'manual_url',
    claimUrl: 'https://www.tripadvisor.com/Owners',
  },
  {
    id: 'bing',
    name: 'Bing Places',
    displayName: 'Bing Places for Business',
    icon: 'bing',
    syncType: 'coming_soon',
    eta: 'Q2 2026',
  },
  {
    id: 'apple',
    name: 'Apple Business Connect',
    displayName: 'Apple Maps Connect',
    icon: 'apple',
    syncType: 'coming_soon',
    eta: 'Q2 2026',
  },
  {
    id: 'facebook',
    name: 'Facebook',
    displayName: 'Facebook Business',
    icon: 'facebook',
    syncType: 'coming_soon',
    eta: 'Q3 2026',
  },
];
```

Adjust the platform list to match whatever the actual "Big 6" in the codebase are ‚Äî do not assume from the report. Read the existing code.

#### Step 3: Replace mock sync action with honest behavior

**In `app/dashboard/integrations/actions.ts`, replace the mock with:**

```typescript
// NEW syncPlatform action:
export async function syncPlatform(platformId: string): Promise<{ ok: boolean; error?: string }> {
  const config = PLATFORM_CONFIG.find((p) => p.id === platformId);
  if (!config) return { ok: false, error: 'unknown_platform' };

  switch (config.syncType) {
    case 'real_oauth':
      // GBP: trigger real import via triggerGBPImport() (Sprint 89 artifact)
      // If Sprint 89 has not run, stub: return { ok: false, error: 'gbp_import_not_available' }
      const result = await triggerGBPImport();
      return result.ok ? { ok: true } : { ok: false, error: result.error_code };

    case 'manual_url':
      // These platforms don't have automated sync. Return success-with-info.
      // The UI handles 'manual_url' platforms differently (see PlatformRow changes).
      return { ok: true };

    case 'coming_soon':
      // Should never be called ‚Äî UI hides the sync button for coming_soon platforms.
      return { ok: false, error: 'not_available' };
  }
}
```

**Remove completely:** The `setTimeout(2000)` mock. The `// Phase 8 uses a mock implementation` comment block. Any `toggleIntegration` mock OAuth state for non-GBP platforms.

#### Step 4: Update `PlatformRow.tsx` ‚Äî three distinct UI states

Each platform row must accurately reflect its `syncType`. Read the existing `PlatformRow` component fully before modifying it ‚Äî preserve any props it already receives.

**State A ‚Äî `real_oauth` (GBP):** Unchanged from what already works. Shows real connect status, real sync timestamp, real "Sync Now" button that triggers `triggerGBPImport()`.

**State B ‚Äî `manual_url` (Yelp, TripAdvisor):**

```tsx
// PlatformRow for manual_url platforms:
<div className="flex items-center justify-between py-4 border-b border-border/50">
  <div className="flex items-center gap-3">
    <PlatformIcon platform={config.id} className="h-8 w-8" />
    <div>
      <p className="text-sm font-medium text-foreground">{config.displayName}</p>
      <p className="text-xs text-muted-foreground">
        Manual URL tracking ‚Äî automated sync coming soon
      </p>
    </div>
  </div>
  <div className="flex items-center gap-2">
    <span className="inline-flex items-center gap-1 rounded-full bg-muted px-2.5 py-1 text-xs font-medium text-muted-foreground">
      <Globe className="h-3 w-3" />
      Manual
    </span>
    <a
      href={config.claimUrl}
      target="_blank"
      rel="noopener noreferrer"
      className="rounded-md border border-input bg-background px-3 py-1.5 text-xs hover:bg-muted transition-colors"
    >
      Manage on {config.displayName} ‚Üó
    </a>
  </div>
</div>
```

**State C ‚Äî `coming_soon` (Bing, Apple, Facebook):**

```tsx
// PlatformRow for coming_soon platforms:
<div className="flex items-center justify-between py-4 border-b border-border/50 opacity-60">
  <div className="flex items-center gap-3">
    <PlatformIcon platform={config.id} className="h-8 w-8 grayscale" />
    <div>
      <p className="text-sm font-medium text-foreground">{config.displayName}</p>
      <p className="text-xs text-muted-foreground">
        Automated sync coming {config.eta ?? 'soon'}
      </p>
    </div>
  </div>
  <span className="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-1 text-xs font-medium text-amber-700 ring-1 ring-amber-200">
    Coming Soon
  </span>
</div>
```

**No "Sync Now" button on manual or coming_soon platforms.** A button that does nothing ‚Äî or simulates doing something ‚Äî must not exist.

#### Step 5: Add a section header explaining manual tracking

At the top of the listings page (or above the manual/coming-soon group), add a dismissible informational note:

```tsx
<div className="mb-6 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-800" data-testid="listings-info-banner">
  <p className="font-medium">About your listings</p>
  <p className="mt-1 text-blue-700">
    <strong>Google Business Profile</strong> syncs automatically when connected. For other platforms,
    LocalVector tracks your listing URL and monitors what AI says about you across all sources ‚Äî
    no API connection required. Bing, Apple Maps, and Facebook automated sync is coming in Q2 2026.
  </p>
</div>
```

#### Step 6: Check if a migration is needed

If `integration_status` or similar is persisted in the DB with a `status` value of `'connected'` for Yelp/TripAdvisor/etc. from the mock syncs, you must clean that data:

```sql
-- Only run this migration if the integrations table persists status in the DB
-- AND if mock 'connected' statuses were written during testing.
-- Check prod_schema.sql for the integrations/platform_connections table first.
-- If status is purely client state, skip this migration entirely.

-- Sprint C: Clear false 'connected' statuses for non-GBP platforms
UPDATE public.platform_connections
SET status = 'manual', synced_at = NULL
WHERE platform_id NOT IN ('google')
  AND status = 'connected';
```

**Check whether this migration is needed** by reading `prod_schema.sql` for any `platform_connections` or `integrations` table. If no such table exists (pure client state), skip this migration entirely and document that in the DEVLOG.

---

### Fix M1: Test Coverage for 6 Untested Services

**This is the largest component of Sprint C.** Five critical services have zero unit tests. Six dashboard pages have no E2E coverage. You will write tests for all of them. This is not glamorous work ‚Äî it is the difference between a codebase you can refactor with confidence and one you can only pray doesn't break.

**Read each service file completely before writing its tests.** Do not write tests based on assumptions about what the service does ‚Äî tests must reflect actual behavior.

#### Service Test 1: `lib/services/cron-logger.ts`

**Target file:** `src/__tests__/unit/cron-logger.test.ts`

Read `cron-logger.ts` fully. Understand:
- What it logs (start, success, failure, duration)
- Whether it writes to `cron_run_log` table in Supabase
- What parameters it accepts
- What it returns

```
describe('cron-logger.ts')

  logCronStart():
  1.  inserts a row into cron_run_log with status='running' and the cron name
  2.  returns the inserted row id (or run_id) for subsequent updates
  3.  includes started_at timestamp
  4.  calls createServiceRoleClient() (not user client)
  5.  if DB insert fails, captures exception to Sentry and does not throw (non-critical logger)

  logCronSuccess():
  6.  updates the cron_run_log row by run_id to status='success'
  7.  sets completed_at and duration_ms
  8.  includes orgs_processed count if provided
  9.  if DB update fails, captures to Sentry silently

  logCronFailure():
  10. updates the cron_run_log row to status='failed'
  11. stores error message string
  12. sets completed_at
  13. if DB update fails, captures to Sentry silently

  General:
  14. all three functions mock the Supabase client ‚Äî no real DB calls
  15. cron name is preserved exactly as passed (case-sensitive)
```

**Target: 15 tests**

#### Service Test 2: `lib/services/entity-auto-detect.ts`

**Target file:** `src/__tests__/unit/entity-auto-detect.test.ts`

Read `entity-auto-detect.ts` fully. This service likely:
- Takes business info (name, address, category) and detects entity attributes
- May call an external API or apply heuristic logic
- Returns a structured entity health result

```
describe('entity-auto-detect.ts')
  [Test cases must be derived from reading the actual implementation]
  
  At minimum, ensure coverage of:
  1.  happy path: valid business info returns a non-null entity result
  2.  missing business name: returns null or throws with a meaningful message
  3.  unknown category: falls back to generic entity type without crashing
  4.  any external API calls are mocked ‚Äî no real network calls in tests
  5.  if the service calls Supabase, mock createServiceRoleClient()
  6.  result shape matches what EntityHealthCard expects (check the component's props)
  7.  handles empty string inputs without crashing
  8.  handles special characters in business name (e.g., "O'Brien's Bar & Grill")
  9.  handles very long business names (> 100 characters)
  10. if a timeout is involved, mock timers appropriately
```

**Target: 10 tests minimum** ‚Äî adjust upward based on the actual complexity of the service. If the service has 5+ distinct code paths, write tests for each.

#### Service Test 3: `lib/gbp/gbp-token-refresh.ts` (or `lib/services/gbp-token-refresh.ts`)

**Target file:** `src/__tests__/unit/gbp-token-refresh.test.ts`

**This is the most critical test file in Sprint C.** Google OAuth tokens expire every 60 minutes. If `refreshGBPToken()` fails silently, every customer with GBP connected loses their integration with no warning.

Note: If Sprint 89 already created this test file (it specifies 10 tests in its DoD), **check first:**
```bash
ls src/__tests__/unit/ | grep gbp-token
```

If the file exists and has 10 passing tests, this service is already covered. Skip to the next service and document in the DEVLOG. If it doesn't exist, write it now.

```
describe('isTokenExpired()')
  1.  returns true when expiresAt is null
  2.  returns true when expiresAt is in the past (expired 1 hour ago)
  3.  returns true when expiresAt is within the 5-minute buffer (expires in 3 minutes)
  4.  returns false when expiresAt is far in the future (expires in 2 hours)
  5.  returns false when expiresAt is exactly 6 minutes away (outside the buffer)
  6.  returns true when expiresAt is an invalid date string

describe('refreshGBPToken()')
  7.  calls Google OAuth endpoint with correct client_id, client_secret, grant_type, refresh_token
  8.  on success (200): updates gbp_connections in DB with new access_token and expires_at
  9.  on success: returns { ok: true, access_token, expires_at }
  10. on Google OAuth 400 error: returns { ok: false, error: 'invalid_grant' } (or the actual error)
  11. on Google OAuth 500 error: returns { ok: false, error: 'refresh_failed' }
  12. on network failure (fetch throws): returns { ok: false, error: string } ‚Äî does not throw
  13. expires_at stored in DB is computed as Date.now() + expires_in * 1000 (verify the formula)
  14. DB update uses createServiceRoleClient() ‚Äî not user-scoped client
  15. env vars GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET are used (mock via vi.stubEnv or process.env)
```

**Target: 15 tests**

Mock `global.fetch` for all Google OAuth calls. Mock the Supabase client for all DB operations. No real network calls or DB writes in any test.

#### Service Test 4: `lib/services/places-refresh.ts`

**Target file:** `src/__tests__/unit/places-refresh.test.ts`

Read `places-refresh.ts` fully. This service likely calls the Google Places API to refresh business details (name, address, hours, rating) and writes to the `locations` table.

```
describe('places-refresh.ts')
  [Derive specific test cases from reading the implementation]

  At minimum cover:
  1.  happy path: valid Places API response updates the locations table correctly
  2.  Places API returns 404 (place not found): handles gracefully, does not overwrite existing data
  3.  Places API returns 403 (quota exceeded): returns error, logs to Sentry
  4.  network failure: returns error, does not crash
  5.  empty fields in Places response: does not overwrite existing non-null DB values with null
  6.  places_id is required: throws or returns error if missing
  7.  DB update uses correct org scoping ‚Äî does not update another org's location
  8.  all Places API calls are mocked via global.fetch
  9.  Supabase client is mocked ‚Äî no real DB writes
  10. maps Places API field names correctly to DB column names (verify against actual mapping)
```

**Target: 10 tests minimum**

#### Service Test 5: `lib/services/sov-seed.ts`

**Target file:** `src/__tests__/unit/sov-seed.test.ts`

Read `sov-seed.ts` fully. This service generates the initial SOV (Share of Voice) query templates for a new organization. The seeds determine what queries LocalVector monitors for this business ‚Äî getting them wrong silently means bad SOV data forever.

```
describe('sov-seed.ts')
  1.  returns an array of query strings (not empty)
  2.  each generated query contains the business name or category
  3.  query count is within expected range (e.g., 5‚Äì20 initial seeds)
  4.  queries are unique (no duplicates in the seed set)
  5.  handles a business with a name containing special characters
  6.  handles a business with no category provided ‚Äî falls back gracefully
  7.  handles a business in an unusual city (not a major metro) ‚Äî still generates valid queries
  8.  if seeding involves a DB write, the Supabase client is mocked
  9.  if seeding calls an LLM API, it is mocked ‚Äî no real API calls in tests
  10. the returned queries are non-empty strings (no empty string in the array)
  11. restaurant-specific queries include location context (city name appears in at least 1 query)
  12. medical/dental business type generates different queries than restaurant type (if supported)
```

**Target: 12 tests**

#### E2E Page Tests (6 pages with no existing coverage)

Create individual spec files for each page. These are smoke-level E2E tests ‚Äî they verify the page loads, key elements render, and primary interactions don't throw. They are not comprehensive behavioral tests.

**File naming:** `src/__tests__/e2e/[page-name].spec.ts`

For each page, read the actual page component (`app/dashboard/[page]/page.tsx`) before writing tests. Know what the page renders before asserting on it.

---

**`src/__tests__/e2e/source-intelligence.spec.ts`** (AI Sources / Source Intelligence page)
```
1.  page loads without error for an authenticated Growth+ user
2.  primary heading or page title is visible
3.  at least one data element renders (citation, source card, or empty state message)
4.  if plan-gated, Starter users see an upgrade prompt (not a blank page)
```

**`src/__tests__/e2e/sentiment.spec.ts`** (AI Sentiment page)
```
1.  page loads without error
2.  primary heading is visible
3.  sentiment chart or sentiment summary renders (or empty state if no data)
4.  model selector or filter renders if present
```

**`src/__tests__/e2e/agent-readiness.spec.ts`** (Agent Readiness page)
```
1.  page loads without error
2.  "Agent Readiness" heading or equivalent is visible
3.  readiness score or readiness categories render (or informative empty state)
4.  InfoTooltip from Sprint B is visible (if wired to this page ‚Äî check)
```

**`src/__tests__/e2e/system-health.spec.ts`** (System Health page)
```
1.  page loads without error for authenticated user
2.  cron run log table or list renders (even if empty)
3.  at least one cron name is shown (from cron_run_log or static list)
4.  a "last run" timestamp column or element is visible
5.  cron rows with 'failed' status display a visual indicator (red badge, error icon)
```

**`src/__tests__/e2e/cluster-map.spec.ts`** (Cluster Map page)
```
1.  page loads without error
2.  cluster visualization element is present in the DOM (canvas, SVG, or chart container)
3.  page does not throw a JavaScript error on load (check console)
4.  if no data: informative empty state is shown (not a blank page)
```

**`src/__tests__/e2e/revenue-impact.spec.ts`** (Revenue Impact page)
```
1.  page loads without error
2.  RevenueConfigForm renders with at least 3 input fields
3.  submitting the form with default values does not crash
4.  revenue estimate output updates after form submission
5.  form default values are restaurant-appropriate (check against M4 defaults ‚Äî $45‚Äì$65 avg check)
```

**Additional E2E edge case tests** ‚Äî create a separate file `src/__tests__/e2e/edge-cases.spec.ts`:

```
describe('Plan downgrade flow')
1.  Agency user who downgrades to Growth loses access to agency-only features immediately on next page load
2.  Growth user who downgrades to Starter no longer sees SOV chart on dashboard

describe('Trial expiry')
3.  Trial-expired user sees an upgrade prompt (not a blank dashboard or error)
4.  Trial-expired user cannot access Growth-gated pages ‚Äî sees upgrade prompt

describe('GBP token expiry')
5.  User with expired GBP token sees a "Reconnect Google Business Profile" prompt in the GBP card
6.  Reconnect prompt links to the GBP OAuth initiation route
```

**Total new E2E tests across all 7 files: approximately 28‚Äì32 tests** (exact count depends on what each page renders ‚Äî adjust up if pages have more distinct states to cover).

---

### Fix L2: Weekly Digest Guard

**The problem:**

`app/api/cron/weekly-digest/route.ts` line 86 has a bare `catch {}` (covered by Sprint A's grep sweep, but this specific fix adds meaningful logic beyond just Sentry). More critically: the cron sends digest emails to orgs that have no scan data yet. A new customer's first email from LocalVector reads "Your Reality Score this week: ‚Äî". That's a terrible first email.

#### Step 1: Fix the bare catch (if not already caught by Sprint A)

Verify Sprint A caught this one:
```bash
grep -n "} catch {" app/api/cron/weekly-digest/route.ts
```

If it still has a bare `catch {}`, apply the standard Sprint A pattern:
```typescript
} catch (err) {
  Sentry.captureException(err, {
    tags: { cron: 'weekly-digest', sprint: 'C' },
    extra: { orgId: currentOrgId ?? 'unknown' },
  });
  // continue processing other orgs
}
```

#### Step 2: Add the scan data guard

Read `app/api/cron/weekly-digest/route.ts` and `lib/services/weekly-digest.service.ts` fully. Understand:
- How orgs are fetched for digest processing
- How scores are fetched per org
- Where the email is sent (Resend call)

**Add guard in the per-org processing loop:**

```typescript
// In the org processing loop ‚Äî add BEFORE building the digest email:

// Guard: skip digest for orgs with no scan data yet
const hasRealData = org.reality_score !== null || org.last_scan_at !== null;
// Adjust field names to match actual column names in your schema

if (!hasRealData) {
  digestSkipCount++;
  console.log(`[Weekly Digest] Skipping org ${org.id} ‚Äî no scan data yet`);
  continue;  // Do not send this org a digest email
}

// Also guard against zero scores that look null-ish:
// If reality_score exists but is from a failed scan (all zeros with no alerts), still send.
// The guard is specifically for orgs where NO scan has ever completed.
```

**Determine the right guard field:** Check what column in `orgs` or `ai_scores` indicates a completed scan. Options include:
- `ai_scores.reality_score IS NOT NULL`
- `orgs.last_scan_at IS NOT NULL`
- `COUNT of hallucination_alerts > 0 OR reality_score IS NOT NULL`

Use whichever is most reliable based on the schema. Document the chosen field in the DEVLOG.

**Add aggregate skip logging** (same pattern as SOV cron from Sprint A):

```typescript
// After the org loop:
let digestSkipCount = 0;  // declare before the loop
let digestSentCount = 0;

// In loop: increment the appropriate counter
// After loop:
console.log(`[Weekly Digest] Sent: ${digestSentCount}, Skipped (no data): ${digestSkipCount}`);

if (digestSkipCount > 0) {
  Sentry.captureMessage(`Weekly digest skipped ${digestSkipCount} orgs with no scan data`, {
    level: 'info',
    tags: { cron: 'weekly-digest', sprint: 'C' },
    extra: { digestSkipCount, digestSentCount },
  });
}
```

#### Step 3: Write tests for L2

**Target file:** `src/__tests__/unit/weekly-digest-guard.test.ts`

```
describe('Weekly digest scan data guard')
  1.  org with reality_score=null is skipped (no email sent)
  2.  org with reality_score=null and last_scan_at=null is skipped
  3.  org with reality_score=62 receives a digest email
  4.  org with reality_score=0 (a real but poor score) receives a digest email (0 ‚â† null)
  5.  org with reality_score=null but last_scan_at set receives a digest (scan ran, score pending)
  6.  digestSkipCount increments for each skipped org
  7.  digestSentCount increments for each sent email
  8.  Sentry.captureMessage is called when skipCount > 0
  9.  Sentry.captureMessage is NOT called when skipCount === 0
  10. Resend (or email service) is NOT called for skipped orgs ‚Äî verify with mock spy
```

**Target: 10 tests**

---

### Fix H6: `monthlyCostPerSeat: null` ‚Äî Fetch from Stripe

**The problem:**

```typescript
// app/actions/seat-actions.ts line 190:
monthlyCostPerSeat: null, // TODO: fetch from Stripe price when Agency pricing is configured
```

Agency customers ‚Äî on the most expensive plan ‚Äî see their per-seat cost as blank on the billing page. This is a broken experience for the highest-value customers.

#### Step 1: Understand the current Stripe setup

Read `lib/stripe/` fully. Understand:
- Which env var holds the Stripe secret key (`STRIPE_SECRET_KEY`? `STRIPE_API_KEY`?)
- Does a `getStripeClient()` or `stripe` singleton already exist?
- Is there a `stripe_price_id` stored on the `orgs` table or in a `subscriptions` table?
- How does the existing billing page fetch subscription data?

**Do not create a new Stripe client** if one already exists. Import and use the existing pattern.

#### Step 2: Fetch the price from Stripe

```typescript
// In app/actions/seat-actions.ts, replace:
monthlyCostPerSeat: null,

// With:
monthlyCostPerSeat: await getMonthlyCostPerSeat(org.stripe_price_id ?? null),
```

**Create `lib/stripe/get-monthly-cost-per-seat.ts`:**

```typescript
import Stripe from 'stripe';
import * as Sentry from '@sentry/nextjs';

/**
 * Fetches the monthly per-seat cost from a Stripe Price object.
 * Returns the unit amount in dollars (not cents) as a number, or null if unavailable.
 *
 * @param stripePriceId - The Stripe Price ID (e.g., "price_1ABC..."). May be null for custom pricing.
 */
export async function getMonthlyCostPerSeat(stripePriceId: string | null): Promise<number | null> {
  if (!stripePriceId) return null;
  if (!process.env.STRIPE_SECRET_KEY) {
    console.warn('[Stripe] STRIPE_SECRET_KEY not set ‚Äî cannot fetch price');
    return null;
  }

  try {
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-12-18.acacia' });
    const price = await stripe.prices.retrieve(stripePriceId);

    if (!price.unit_amount) return null;  // metered or variable pricing
    if (price.recurring?.interval === 'year') {
      // Convert annual price to monthly equivalent
      return Math.round((price.unit_amount / 12) / 100);
    }
    // Monthly price: convert from cents to dollars
    return price.unit_amount / 100;
  } catch (err) {
    Sentry.captureException(err, {
      tags: { function: 'getMonthlyCostPerSeat', sprint: 'C' },
      extra: { stripePriceId },
    });
    return null;  // Graceful fallback ‚Äî don't crash seat actions for a price lookup failure
  }
}
```

**Use exact Stripe API version:** Check `package.json` for the installed `stripe` npm version. Use the matching `apiVersion` string. Do not use a version newer than the installed SDK supports.

#### Step 3: Update `SeatManagementCard.tsx` to display the cost

Read `SeatManagementCard.tsx`. Find where `monthlyCostPerSeat` is rendered. Currently it shows `null` or a dash. Update:

```tsx
// Replace the null-displaying placeholder with:
{monthlyCostPerSeat !== null ? (
  <p className="text-sm text-foreground">
    <span className="font-semibold">${monthlyCostPerSeat}/seat/mo</span>
  </p>
) : (
  <p className="text-sm text-muted-foreground">
    Contact us for custom seat pricing
  </p>
)}
```

The "Contact us" fallback is correct for Agency customers with truly custom pricing (no `stripe_price_id`).

#### Step 4: Write tests for H6

**Target file:** `src/__tests__/unit/get-monthly-cost-per-seat.test.ts`

```
describe('getMonthlyCostPerSeat()')
  1.  returns null when stripePriceId is null
  2.  returns null when STRIPE_SECRET_KEY env var is not set
  3.  calls stripe.prices.retrieve with the correct price ID
  4.  converts Stripe cents to dollars: unit_amount=2900 ‚Üí returns 29
  5.  handles annual price: unit_amount=34800 (annual) ‚Üí returns 29 (monthly equivalent)
  6.  returns null when unit_amount is null or 0 (metered pricing)
  7.  when Stripe API throws, captures to Sentry and returns null (no re-throw)
  8.  when Stripe API throws, does NOT propagate the error to the caller
  9.  uses createServiceRoleClient pattern... (adjust if Stripe is called server-side outside Supabase context)
  10. the Stripe client is mocked ‚Äî no real Stripe API calls in tests
```

**Target: 10 tests**

Mock Stripe via `vi.mock('stripe')`. Do not make real Stripe API calls in tests.

---

### Fix L3: Content Calendar ‚Üí Drafts Breadcrumb

**The problem:** Drafts that originated from the Occasion Engine (Content Calendar) are indistinguishable from manually created drafts. Users land on the Drafts page and see a list of posts with no indication of where they came from.

**This is the smallest fix in Sprint C.** Read the content-calendar and content-drafts data models before implementing.

#### Step 1: Check the DB schema

Look at `prod_schema.sql` for the `content_drafts` (or equivalent) table. Check whether an `occasion_id`, `source`, or `calendar_event_id` column already exists.

```bash
grep -A 20 "CREATE TABLE.*content_draft\|CREATE TABLE.*occasion_draft" supabase/prod_schema.sql
```

**If an `occasion_id` or `source` column already exists:** The data linkage is already in the DB ‚Äî you only need to surface it in the UI. No migration needed.

**If no source column exists:** Add a nullable column:

```sql
-- Sprint C: Link content drafts to their calendar origin
ALTER TABLE public.content_drafts
  ADD COLUMN IF NOT EXISTS occasion_id uuid REFERENCES public.occasions(id) ON DELETE SET NULL;

COMMENT ON COLUMN public.content_drafts.occasion_id IS
  'If set, this draft was generated from a calendar occasion. Sprint C.';
```

Only write this migration if the column genuinely doesn't exist. Do not add a column that's already there.

#### Step 2: Surface the origin tag in the Drafts UI

In `app/dashboard/content-drafts/` ‚Äî find the draft list item component. Add a small origin tag when `occasion_id` is non-null:

```tsx
{draft.occasion_id && (
  <span
    className="inline-flex items-center gap-1 rounded-full bg-violet-100 px-2 py-0.5 text-[10px] font-medium text-violet-700 ring-1 ring-violet-200"
    data-testid="draft-origin-tag"
  >
    <CalendarDays className="h-2.5 w-2.5" aria-hidden="true" />
    Occasion Engine
  </span>
)}
```

Import `CalendarDays` from `'lucide-react'`.

**Add a link back to the originating calendar event** (if the occasion data is available in the draft query):

```tsx
{draft.occasion_id && (
  <Link
    href={`/dashboard/content-calendar?occasion=${draft.occasion_id}`}
    className="text-[10px] text-muted-foreground hover:text-foreground underline"
  >
    View in Calendar ‚Üí
  </Link>
)}
```

Only add this link if the Calendar page supports `?occasion=` query parameter for scrolling to a specific occasion. If it doesn't, add just the tag without the link for now.

#### Step 3: Update the draft fetch query

If `occasion_id` is a new column or wasn't in the existing SELECT query, update the draft fetch to include it:

```typescript
// In whatever server action or route fetches content_drafts:
.select('id, title, status, created_at, occasion_id, ...other columns')
```

#### Step 4: Write tests for L3

```
describe('Content draft origin tag')
  1.  draft with occasion_id renders the "Occasion Engine" tag with data-testid="draft-origin-tag"
  2.  draft without occasion_id does NOT render the origin tag
  3.  the origin tag is accessible (has meaningful text content readable by screen readers)
  4.  "View in Calendar" link is present when occasion_id is set (if calendar supports the param)
  5.  "View in Calendar" link is not present when occasion_id is null
```

**Target: 5 tests**

---

## üß™ Complete Test Summary

### All unit test files in Sprint C:

| File | Tests | Priority |
|------|-------|----------|
| `src/__tests__/unit/cron-logger.test.ts` | 15 | M1 |
| `src/__tests__/unit/entity-auto-detect.test.ts` | 10 min | M1 |
| `src/__tests__/unit/gbp-token-refresh.test.ts` | 15 (or skip if exists) | M1/L5 |
| `src/__tests__/unit/places-refresh.test.ts` | 10 min | M1 |
| `src/__tests__/unit/sov-seed.test.ts` | 12 | M1 |
| `src/__tests__/unit/weekly-digest-guard.test.ts` | 10 | L2 |
| `src/__tests__/unit/get-monthly-cost-per-seat.test.ts` | 10 | H6 |
| `src/__tests__/unit/content-draft-origin.test.ts` | 5 | L3 |

**Total Vitest: ~87 tests** (adjust based on actual service complexity)

### All E2E test files in Sprint C:

| File | Tests | Coverage |
|------|-------|----------|
| `src/__tests__/e2e/source-intelligence.spec.ts` | 4 | M1 |
| `src/__tests__/e2e/sentiment.spec.ts` | 4 | M1 |
| `src/__tests__/e2e/agent-readiness.spec.ts` | 4 | M1 |
| `src/__tests__/e2e/system-health.spec.ts` | 5 | M1 |
| `src/__tests__/e2e/cluster-map.spec.ts` | 4 | M1 |
| `src/__tests__/e2e/revenue-impact.spec.ts` | 5 | M1 |
| `src/__tests__/e2e/edge-cases.spec.ts` | 6 | M1 |
| `src/__tests__/e2e/listings-honest-state.spec.ts` | 8 | C2 |

**Total Playwright: ~40 tests**

### E2E tests for C2 (listings) ‚Äî `src/__tests__/e2e/listings-honest-state.spec.ts`:

```
describe('Listings ‚Äî honest state')
  1.  GBP row shows real sync status (not a simulated one)
  2.  Yelp row shows "Manual" badge (not "Connected" or a Sync button)
  3.  TripAdvisor row shows "Manual" badge
  4.  Bing row shows "Coming Soon" badge
  5.  Apple Maps row shows "Coming Soon" badge
  6.  No "Sync Now" button exists for Yelp or TripAdvisor
  7.  "Manage on Yelp for Business" external link is present for Yelp row
  8.  listings-info-banner is visible on the page
```

### Run commands:

```bash
# Unit tests (run individually first to spot failures early):
npx vitest run src/__tests__/unit/cron-logger.test.ts
npx vitest run src/__tests__/unit/entity-auto-detect.test.ts
npx vitest run src/__tests__/unit/gbp-token-refresh.test.ts
npx vitest run src/__tests__/unit/places-refresh.test.ts
npx vitest run src/__tests__/unit/sov-seed.test.ts
npx vitest run src/__tests__/unit/weekly-digest-guard.test.ts
npx vitest run src/__tests__/unit/get-monthly-cost-per-seat.test.ts
npx vitest run src/__tests__/unit/content-draft-origin.test.ts

# Full unit suite ‚Äî no regressions:
npx vitest run

# E2E tests:
npx playwright test src/__tests__/e2e/listings-honest-state.spec.ts
npx playwright test src/__tests__/e2e/source-intelligence.spec.ts
npx playwright test src/__tests__/e2e/sentiment.spec.ts
npx playwright test src/__tests__/e2e/agent-readiness.spec.ts
npx playwright test src/__tests__/e2e/system-health.spec.ts
npx playwright test src/__tests__/e2e/cluster-map.spec.ts
npx playwright test src/__tests__/e2e/revenue-impact.spec.ts
npx playwright test src/__tests__/e2e/edge-cases.spec.ts

# Type check:
npx tsc --noEmit                                                # 0 new type errors
```

---

## üìÇ Files to Create / Modify

| # | File | Action | Fix |
|---|------|--------|-----|
| 1 | `lib/integrations/platform-config.ts` | **CREATE** | C2 ‚Äî Platform sync type definitions |
| 2 | `app/dashboard/integrations/actions.ts` | **MODIFY** | C2 ‚Äî Remove mock; honest syncPlatform |
| 3 | `app/dashboard/integrations/_components/PlatformRow.tsx` | **MODIFY** | C2 ‚Äî 3 distinct UI states |
| 4 | `app/dashboard/integrations/page.tsx` | **MODIFY** | C2 ‚Äî Add listings-info-banner |
| 5 | `supabase/migrations/[timestamp]_clear_false_integrations.sql` | **CREATE IF NEEDED** | C2 ‚Äî Clear mock connected statuses |
| 6 | `src/__tests__/unit/cron-logger.test.ts` | **CREATE** | M1 ‚Äî 15 tests |
| 7 | `src/__tests__/unit/entity-auto-detect.test.ts` | **CREATE** | M1 ‚Äî 10+ tests |
| 8 | `src/__tests__/unit/gbp-token-refresh.test.ts` | **CREATE IF MISSING** | M1/L5 ‚Äî 15 tests |
| 9 | `src/__tests__/unit/places-refresh.test.ts` | **CREATE** | M1 ‚Äî 10+ tests |
| 10 | `src/__tests__/unit/sov-seed.test.ts` | **CREATE** | M1 ‚Äî 12 tests |
| 11 | `src/__tests__/e2e/source-intelligence.spec.ts` | **CREATE** | M1 ‚Äî 4 tests |
| 12 | `src/__tests__/e2e/sentiment.spec.ts` | **CREATE** | M1 ‚Äî 4 tests |
| 13 | `src/__tests__/e2e/agent-readiness.spec.ts` | **CREATE** | M1 ‚Äî 4 tests |
| 14 | `src/__tests__/e2e/system-health.spec.ts` | **CREATE** | M1 ‚Äî 5 tests |
| 15 | `src/__tests__/e2e/cluster-map.spec.ts` | **CREATE** | M1 ‚Äî 4 tests |
| 16 | `src/__tests__/e2e/revenue-impact.spec.ts` | **CREATE** | M1 ‚Äî 5 tests |
| 17 | `src/__tests__/e2e/edge-cases.spec.ts` | **CREATE** | M1 ‚Äî 6 tests |
| 18 | `src/__tests__/e2e/listings-honest-state.spec.ts` | **CREATE** | C2 ‚Äî 8 tests |
| 19 | `app/api/cron/weekly-digest/route.ts` | **MODIFY** | L2 ‚Äî Guard + Sentry + skip logging |
| 20 | `lib/services/weekly-digest.service.ts` | **MODIFY IF NEEDED** | L2 ‚Äî Guard may live here instead |
| 21 | `src/__tests__/unit/weekly-digest-guard.test.ts` | **CREATE** | L2 ‚Äî 10 tests |
| 22 | `lib/stripe/get-monthly-cost-per-seat.ts` | **CREATE** | H6 ‚Äî Stripe price fetch utility |
| 23 | `app/actions/seat-actions.ts` | **MODIFY** | H6 ‚Äî Replace null with real fetch |
| 24 | `app/dashboard/billing/_components/SeatManagementCard.tsx` | **MODIFY** | H6 ‚Äî Display real cost or fallback |
| 25 | `src/__tests__/unit/get-monthly-cost-per-seat.test.ts` | **CREATE** | H6 ‚Äî 10 tests |
| 26 | `app/dashboard/content-drafts/` (draft list component) | **MODIFY** | L3 ‚Äî Origin tag |
| 27 | `supabase/migrations/[timestamp]_content_drafts_occasion_id.sql` | **CREATE IF NEEDED** | L3 ‚Äî occasion_id column |
| 28 | `supabase/prod_schema.sql` | **MODIFY IF NEEDED** | L3 ‚Äî schema update |
| 29 | `lib/supabase/database.types.ts` | **MODIFY IF NEEDED** | L3 + H6 ‚Äî new columns |
| 30 | `src/__tests__/unit/content-draft-origin.test.ts` | **CREATE** | L3 ‚Äî 5 tests |

---

## üß† Edge Cases to Handle

1. **C2 ‚Äî Platform list doesn't match the hardcoded 6.** The report says "Big 6 Listings" but the actual platforms may differ (different count, different names, different icons). Read the existing code ‚Äî do not assume. `PLATFORM_CONFIG` must match whatever platforms actually exist in the integrations page.

2. **C2 ‚Äî Real GBP sync in `syncPlatform` depends on Sprint 89.** If Sprint 89 (GBP import) has not been merged yet, `triggerGBPImport()` doesn't exist. In that case, stub the GBP sync: `return { ok: false, error: 'gbp_import_pending_sprint_89' }` and note in the DEVLOG that GBP sync is blocked on Sprint 89.

3. **C2 ‚Äî Integration status in DB vs. client state.** If `platform_connections` table exists and has `status = 'connected'` for Yelp from the mock syncs, that dirty data must be cleaned up. If it's purely client state (no DB persistence), there's nothing to clean ‚Äî just fix the UI behavior going forward.

4. **M1 ‚Äî `gbp-token-refresh.test.ts` may already exist.** Sprint 89's DoD requires 10 passing tests for this service. Check before writing. If it exists, document that it was already covered and move on. Do not overwrite a passing test file with a new one.

5. **M1 ‚Äî Service complexity may vary.** Some services may be 20 lines, others 200. Scale the test count accordingly. The targets (10, 12, 15) are minimums ‚Äî if the service has complex branching logic, write more. If it's trivial, fewer tests are fine as long as all code paths are covered.

6. **M1 ‚Äî E2E tests on pages that require specific data.** System Health requires `cron_run_log` entries. Revenue Impact requires at least one revenue config. Cluster Map requires SOV data. For tests that need DB data, use `page.route()` to mock the Supabase API calls rather than relying on real DB state in the test environment.

7. **L2 ‚Äî "Has scan data" definition.** The guard must be based on a reliable indicator. `reality_score IS NOT NULL` is the most direct. If `reality_score` can be null even after a scan (e.g., if the scan failed), use `last_scan_at IS NOT NULL` as a secondary check. Document the chosen heuristic in the DEVLOG and in a code comment.

8. **L2 ‚Äî Existing orgs with no scan data.** If there are existing paying customers who've never had a scan run (e.g., onboarded but cron never ran successfully), this guard will permanently suppress their digest. This is intentional ‚Äî a digest with no data is worse than no digest. After their first successful scan, the guard will pass and they'll receive future digests normally.

9. **H6 ‚Äî Stripe API version mismatch.** The `apiVersion` in `new Stripe(key, { apiVersion: '...' })` must match the installed SDK. Check `package.json` for the `stripe` version and use the correct API version string. An incorrect version string causes a TypeScript error at compile time.

10. **H6 ‚Äî `stripe_price_id` may not exist on the `orgs` table.** If Agency pricing is truly custom (negotiated per customer), there may be no Stripe price ID in the DB. In that case, `getMonthlyCostPerSeat(null)` returns `null` and the "Contact us for custom seat pricing" fallback renders. This is the correct behavior for custom-priced customers.

11. **H6 ‚Äî Annual vs. monthly pricing.** The Stripe Price may be configured as annual billing even if displayed as "per month." The `get-monthly-cost-per-seat.ts` function handles this by dividing annual `unit_amount` by 12. Verify that the price ID stored in the DB corresponds to the monthly price (not the annual one) before using it. If it's always monthly, remove the annual conversion branch but keep a comment explaining why.

12. **L3 ‚Äî Content Calendar `?occasion=` param may not be implemented.** Only add the "View in Calendar ‚Üí" link if navigating to `/dashboard/content-calendar?occasion=<id>` actually scrolls to or highlights that occasion. If the Calendar page ignores query params, the link is misleading. In that case, show only the tag (not the link) and note in the DEVLOG that Calendar deep-linking is deferred.

13. **M1 ‚Äî `entity-auto-detect.ts` may call an LLM.** If this service makes OpenAI or Perplexity API calls, those calls must be mocked in tests via `vi.mock` or `global.fetch` mock. Never allow real LLM calls in unit tests ‚Äî they are slow, expensive, and non-deterministic.

---

## üö´ What NOT to Do

1. **DO NOT wire real Yelp, TripAdvisor, Bing, or Apple Business Connect APIs in this sprint.** That is a separate sprint (C2b or equivalent). This sprint makes the current state honest ‚Äî not complete. The "coming soon" label is the correct interim state.
2. **DO NOT delete the mock sync action entirely** without replacing it. The `syncPlatform` action must still exist and handle all platform IDs ‚Äî it just returns honest results instead of simulating a fake sync.
3. **DO NOT write tests that make real network calls** ‚Äî no real Stripe API calls, no real Google Places calls, no real GBP OAuth calls, no real Supabase DB writes. Every test that touches external services must use mocks.
4. **DO NOT modify existing passing tests** from Sprints A and B. Write new test files. Run `npx vitest run` after all new tests pass to confirm zero regressions.
5. **DO NOT use `as any` on Supabase clients** (AI_RULES ¬ß38.2).
6. **DO NOT use dynamic Tailwind class construction** (AI_RULES ¬ß12).
7. **DO NOT modify `middleware.ts`** (AI_RULES ¬ß6).
8. **DO NOT overwrite `gbp-token-refresh.test.ts`** if Sprint 89 already created and passed it. Check first; skip if already covered.
9. **DO NOT use `page.waitForTimeout()` in Playwright tests** ‚Äî use event-driven waits (`page.waitForSelector`, `page.waitForResponse`).
10. **DO NOT add the Stripe price fetch to a client component.** `getMonthlyCostPerSeat()` is a server-only function. It may only be called from Server Actions, Route Handlers, or Server Components. Never import it in a `'use client'` file.
11. **DO NOT send the weekly digest to orgs with no scan data** ‚Äî the guard must execute before the Resend call, not after.
12. **DO NOT add `data-testid` attributes to the `coming_soon` platform rows' "Connect" buttons** ‚Äî those buttons must not exist at all.

---

## ‚úÖ Definition of Done (AI_RULES ¬ß13.5)

**C2 ‚Äî Honest Listings:**
- [ ] `lib/integrations/platform-config.ts` created with `PLATFORM_CONFIG` covering all platforms
- [ ] `syncPlatform()` server action no longer contains `setTimeout` mock or fake `connected` state
- [ ] GBP row: real OAuth connect/sync behavior unchanged
- [ ] Yelp + TripAdvisor rows: "Manual" badge + "Manage on [Platform]" external link; no Sync button
- [ ] Bing + Apple + Facebook rows (or equivalent): "Coming Soon" badge; opacity-60; no Sync button
- [ ] `listings-info-banner` visible on the listings page (`data-testid="listings-info-banner"`)
- [ ] DB data guard executed (migration run if needed, or confirmed not needed)
- [ ] `grep -n "setTimeout" app/dashboard/integrations/actions.ts` returns 0 results

**M1 ‚Äî Test Coverage:**
- [ ] `cron-logger.test.ts` ‚Äî 15 tests passing
- [ ] `entity-auto-detect.test.ts` ‚Äî 10+ tests passing
- [ ] `gbp-token-refresh.test.ts` ‚Äî 15 tests passing (or confirmed already covered by Sprint 89)
- [ ] `places-refresh.test.ts` ‚Äî 10+ tests passing
- [ ] `sov-seed.test.ts` ‚Äî 12 tests passing
- [ ] All 7 new E2E spec files ‚Äî all tests passing
- [ ] `listings-honest-state.spec.ts` ‚Äî 8 tests passing
- [ ] No real network calls in any unit test (verified by grep for non-mocked fetch/axios calls)

**L2 ‚Äî Weekly Digest Guard:**
- [ ] `weekly-digest/route.ts` ‚Äî bare `catch {}` at line 86 replaced with Sentry + continue
- [ ] Guard skips email send for orgs with no scan data (null `reality_score` or no `last_scan_at`)
- [ ] `digestSkipCount` and `digestSentCount` tracked and logged after the loop
- [ ] `Sentry.captureMessage` called when any orgs are skipped
- [ ] `weekly-digest-guard.test.ts` ‚Äî 10 tests passing
- [ ] Resend (or email service) confirmed to NOT be called for skipped orgs (test spy assertion)

**H6 ‚Äî Seat Cost:**
- [ ] `lib/stripe/get-monthly-cost-per-seat.ts` created ‚Äî handles null price ID, annual/monthly conversion, Stripe errors
- [ ] `seat-actions.ts` line 190 no longer has `null` or `// TODO` comment
- [ ] `SeatManagementCard.tsx` renders `$X/seat/mo` for Agency customers with known price, "Contact us" fallback for custom pricing
- [ ] `get-monthly-cost-per-seat.test.ts` ‚Äî 10 tests passing
- [ ] Stripe is mocked in all tests ‚Äî no real Stripe API calls

**L3 ‚Äî Content Calendar Breadcrumb:**
- [ ] Drafts originating from Occasion Engine show "Occasion Engine" tag with `data-testid="draft-origin-tag"`
- [ ] Drafts without `occasion_id` show no origin tag
- [ ] Migration created if `occasion_id` column was missing (or confirmed already existed)
- [ ] `content-draft-origin.test.ts` ‚Äî 5 tests passing

**All tests:**
- [ ] `npx vitest run` ‚Äî ALL tests passing (Sprints A, B, C), zero regressions
- [ ] `npx playwright test` ‚Äî ALL E2E tests passing, zero regressions
- [ ] `npx tsc --noEmit` ‚Äî 0 new type errors
- [ ] DEVLOG.md entry written with actual test counts

---

## üìì DEVLOG Entry Format (AI_RULES ¬ß13.2)

```markdown
## [DATE] ‚Äî Sprint C: Hardening ‚Äî Honest Listings, Test Coverage, Digest Guard & Seat Cost (Completed)

**Goal:** Close the remaining critical and medium-priority gaps. Make the product honest (no fake syncs), reliable (untested services covered), and complete (digest guard, seat cost, content breadcrumb).

**Scope:**
- `lib/integrations/platform-config.ts` ‚Äî **NEW.** PLATFORM_CONFIG: [N] platforms with syncType ('real_oauth' | 'manual_url' | 'coming_soon').
- `app/dashboard/integrations/actions.ts` ‚Äî **MODIFIED.** Mock setTimeout removed. `syncPlatform()` now: GBP ‚Üí real import; manual URL platforms ‚Üí honest return; coming_soon ‚Üí error. 0 setTimeout calls remain.
- `app/dashboard/integrations/_components/PlatformRow.tsx` ‚Äî **MODIFIED.** 3 distinct UI states: GBP (real OAuth), manual (badge + external link, no Sync button), coming_soon (badge + opacity-60, no Sync button).
- `app/dashboard/integrations/page.tsx` ‚Äî **MODIFIED.** listings-info-banner added explaining sync types.
- DB migration: [RAN / NOT NEEDED ‚Äî pure client state, no persistent false statuses to clear]
- `src/__tests__/unit/cron-logger.test.ts` ‚Äî **NEW.** [N] tests: logCronStart, logCronSuccess, logCronFailure.
- `src/__tests__/unit/entity-auto-detect.test.ts` ‚Äî **NEW.** [N] tests: [brief summary of coverage].
- `src/__tests__/unit/gbp-token-refresh.test.ts` ‚Äî **[NEW / ALREADY EXISTED from Sprint 89].** [N] tests: isTokenExpired, refreshGBPToken.
- `src/__tests__/unit/places-refresh.test.ts` ‚Äî **NEW.** [N] tests: [brief summary].
- `src/__tests__/unit/sov-seed.test.ts` ‚Äî **NEW.** [N] tests: [brief summary].
- E2E: 7 new page spec files created: source-intelligence, sentiment, agent-readiness, system-health, cluster-map, revenue-impact, edge-cases. Total [N] new E2E tests.
- `app/api/cron/weekly-digest/route.ts` ‚Äî **MODIFIED.** Bare catch at line 86 fixed (Sentry). Guard added: orgs with no scan data are skipped. digestSkipCount + digestSentCount logged. Sentry.captureMessage when skip > 0.
- Digest guard field chosen: [reality_score IS NOT NULL / last_scan_at IS NOT NULL] ‚Äî documented in code comment.
- `src/__tests__/unit/weekly-digest-guard.test.ts` ‚Äî **NEW.** [N] tests: skip logic, send logic, Sentry call, Resend not-called assertion.
- `lib/stripe/get-monthly-cost-per-seat.ts` ‚Äî **NEW.** Fetches Stripe price, converts cents‚Üídollars, handles annual pricing, graceful Sentry fallback.
- `app/actions/seat-actions.ts` ‚Äî **MODIFIED.** `monthlyCostPerSeat: null` TODO replaced with `await getMonthlyCostPerSeat(org.stripe_price_id)`.
- `SeatManagementCard.tsx` ‚Äî **MODIFIED.** Renders `$X/seat/mo` or "Contact us for custom seat pricing" fallback.
- `src/__tests__/unit/get-monthly-cost-per-seat.test.ts` ‚Äî **NEW.** [N] tests: null guard, Stripe mock, cents‚Üídollars, annual‚Üímonthly, error handling.
- Content drafts origin tag ‚Äî **MODIFIED.** `occasion_id` [already existed / new column + migration]. "Occasion Engine" tag renders on drafts with non-null occasion_id.
- `src/__tests__/unit/content-draft-origin.test.ts` ‚Äî **NEW.** [N] tests.

**Tests added:**
- Vitest unit: [N] total new tests ([N] files)
- Playwright E2E: [N] total new tests ([N] files)
- Total across all sprints (A+B+C): [N] Vitest + [N] Playwright

**Before/After:**
- Before: 5 of 6 listing platforms showed a fake "Connected" after a 2-second setTimeout. After: honest UI ‚Äî Manual badge for trackable platforms, Coming Soon for future integrations. grep for setTimeout in integrations/actions.ts = 0.
- Before: 5 critical services had zero unit tests. After: [N] tests across all 5 services.
- Before: Weekly digest sent to new users with no data. After: orgs with no scan data are skipped; [N] orgs skipped in the first cron run after deployment.
- Before: Agency customers saw monthlyCostPerSeat: null. After: real Stripe price displayed or "Contact us" fallback.
- Before: Calendar-originated drafts indistinguishable from manual drafts. After: "Occasion Engine" tag on calendar-originated drafts.
```

---

## üîÆ AI_RULES Update (Add to `AI_RULES.md`)

```markdown
## 47. üö´ No Mock Sync in Production UI (Sprint C)

Production UI must never simulate API calls with setTimeout or set a false 'connected' status.

* **Rule:** Any sync/connect action must either perform the real operation or return an honest error state.
* **Acceptable states:** 'connected' (real), 'manual' (no API available), 'coming_soon' (not yet built), 'error' (real failure).
* **Banned patterns:** `setTimeout` + `setStatus('connected')`, fake progress indicators that don't reflect real work.
* **Labeling:** Platforms without automated sync must display "Manual URL tracking" or "Coming soon" ‚Äî not a Sync button.

## 48. üîç Stripe Price Fetches Are Server-Only (Sprint C)

`lib/stripe/get-monthly-cost-per-seat.ts` and all Stripe API calls are server-only.

* **Rule:** Never import Stripe utilities into 'use client' files.
* **Error handling:** All Stripe API calls must have try/catch with Sentry.captureException and null/fallback return ‚Äî never re-throw.
* **API version:** Always use the apiVersion string matching the installed stripe npm package version.

## 49. üìã Weekly Digest Guard ‚Äî No Data, No Email (Sprint C)

The weekly digest cron must not send emails to orgs with no scan data.

* **Rule:** Check reality_score IS NOT NULL (or the chosen guard field) before building and sending any digest email.
* **Logging:** digestSkipCount and digestSentCount must be logged after every cron run.
* **Sentry:** captureMessage (level: 'info') when any orgs are skipped.
```

---

## üìö Document Sync + Git Commit

### Step 1: Update `CLAUDE.md`

```markdown
### Sprint C ‚Äî Hardening (2026-[DATE])
- `lib/integrations/platform-config.ts` ‚Äî PLATFORM_CONFIG: real_oauth / manual_url / coming_soon
- integrations/actions.ts: mock setTimeout removed; honest syncPlatform() replaces it
- PlatformRow.tsx: 3 distinct UI states (real OAuth / manual / coming soon)
- `lib/stripe/get-monthly-cost-per-seat.ts` ‚Äî server-only Stripe price fetch utility
- seat-actions.ts: monthlyCostPerSeat now fetched from Stripe (no more null TODO)
- weekly-digest: scan data guard added; skips orgs with no reality_score data
- content-drafts: origin tag ("Occasion Engine") on drafts from content calendar
- Tests: [N] new unit tests across 8 files; [N] new E2E tests across 8 files
- All sprints (A+B+C): [N] total Vitest + [N] total Playwright passing
```

### Step 2: Update `MEMORY.md`

```markdown
## Decision: Listings Honest State Architecture (Sprint C ‚Äî 2026-[DATE])
- PLATFORM_CONFIG in lib/integrations/platform-config.ts is the single source of truth for platform sync types
- real_oauth: GBP only ‚Äî real OAuth + real sync via triggerGBPImport()
- manual_url: Yelp, TripAdvisor ‚Äî external manage link; no sync button; "Manual" badge
- coming_soon: Bing, Apple, Facebook ‚Äî Coming Soon badge; no interaction; opacity-60
- Full API wiring for manual/coming_soon platforms deferred to a future sprint

## Decision: Weekly Digest Guard Field (Sprint C ‚Äî 2026-[DATE])
- Guard field chosen: [document actual field here]
- Rationale: [document why this field was chosen over alternatives]
- Orgs with null guard field receive no weekly digest until first scan completes
```

### Step 3: Update `AI_RULES.md`

Append Rules 47, 48, and 49 from the **üîÆ AI_RULES Update** section above.

### Step 4: Git Commit

```bash
git add -A
git status

git commit -m "Sprint C: Hardening ‚Äî Honest Listings, Test Coverage, Digest Guard & Seat Cost

- lib/integrations/platform-config.ts: PLATFORM_CONFIG (real_oauth/manual_url/coming_soon)
- integrations: mock setTimeout removed; PlatformRow 3 honest UI states; listings-info-banner
- M1 tests: [N] new unit tests for cron-logger, entity-auto-detect, gbp-token-refresh, places-refresh, sov-seed
- M1 E2E: source-intelligence, sentiment, agent-readiness, system-health, cluster-map, revenue-impact, edge-cases
- weekly-digest: bare catch fixed; scan data guard (skip orgs with no reality_score); digestSkipCount logging
- lib/stripe/get-monthly-cost-per-seat.ts: Stripe price fetch; cents‚Üídollars; graceful null fallback
- seat-actions.ts: monthlyCostPerSeat null TODO resolved; SeatManagementCard shows real cost or 'Contact us'
- content-drafts: 'Occasion Engine' origin tag on calendar-originated drafts
- tests: [N] Vitest + [N] Playwright passing, 0 regressions across all sprints (A+B+C)
- AI_RULES: Rules 47 (no mock sync), 48 (Stripe server-only), 49 (digest guard)

Fixes: C2 (honest listings), M1 (test gaps), L2 (digest guard), H6 (seat cost), L3 (breadcrumb)
All critical and high-priority gaps from the February 2026 code analysis are now resolved."

git push origin main
```

---

## üèÅ Sprint Outcome

After Sprint C completes, the LocalVector V1 codebase will have closed every **Critical**, **High**, and the most impactful **Medium/Low** priority gaps from the February 2026 code analysis:

- **C1** ‚úÖ Sprint A ‚Äî Sentry on all catches
- **C2** ‚úÖ Sprint C ‚Äî Honest listings (no more fake syncs)
- **C3** ‚úÖ Sprint A ‚Äî Unified plan names
- **C4** ‚úÖ Sprint B ‚Äî Sample data mode
- **H1** ‚úÖ Sprint B ‚Äî InfoTooltip system
- **H2** ‚úÖ Sprint B ‚Äî Settings expansion
- **H3** ‚úÖ Sprint A ‚Äî SOV cron logging
- **H4** ‚úÖ Sprint A ‚Äî Sidebar grouped navigation
- **H5** ‚úÖ Sprint A ‚Äî Dashboard card links
- **H6** ‚úÖ Sprint C ‚Äî monthlyCostPerSeat from Stripe
- **M1** ‚úÖ Sprint C ‚Äî Test coverage for 6 untested services + 6 E2E pages
- **M3** ‚úÖ Sprint B ‚Äî Plan feature comparison table
- **L2** ‚úÖ Sprint C ‚Äî Weekly digest guard
- **L3** ‚úÖ Sprint C ‚Äî Content calendar breadcrumb
- **L4** ‚úÖ Sprint A ‚Äî ViralScanner error handling
- **L5** ‚úÖ Sprint C (or Sprint 89) ‚Äî GBP token refresh tests

**What remains (deferred to backlog):**
- M2: GuidedTour expansion (Restart Tour trigger was added in Sprint B; more tour steps deferred)
- M4: Revenue config restaurant defaults
- M5: Medical/dental vertical extension
- M6: AI vs. traditional SEO in-app positioning
- L1: Admin operations dashboard
- N1‚ÄìN4: Credits system, on-demand AI preview, correction follow-up, benchmarks

The product is now ready for active customer acquisition without meaningful trust or reliability risks from known code issues.
